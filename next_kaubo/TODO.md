# Kaubo 开发任务清单

> 记录设计问题、技术债务和开发计划

## 🔥 高优先级（当前迭代）

### 1. 架构重构 3.0 🚧

**状态**: 进行中 - 文档已完成，开始实施代码

**目标**: 现代化日志系统、配置管理、API 分层

- [x] 方案设计
- [x] 文档更新
- [ ] 依赖添加 (`tracing`, `clap`, `once_cell`, `thiserror`)
- [ ] 配置系统 (`config.rs`)
- [ ] 日志系统 (`logger.rs`)
- [ ] API 封装 (`api.rs`)
- [ ] 分阶段替换日志
  - [ ] Lexer 日志
  - [ ] Parser 日志
  - [ ] Compiler 日志
  - [ ] VM 日志
- [ ] CLI 重构 (`main.rs`)
- [ ] 测试重构

---

### 2. 错误处理完善 ⭐⭐⭐

**目标**: 提供清晰、有上下文的错误信息

- [ ] **编译错误改进**
  - [ ] 添加行号、列号信息到 Token
  - [ ] 格式化错误输出（类似 Rust 的错误格式）
  - [ ] 常见错误提示（如未导入的模块）

- [ ] **运行时错误**
  - [ ] 添加调用堆栈追踪
  - [ ] 保留源码位置信息在字节码中

---

### 3. 字节码版本号 ⭐⭐⭐

**目标**: 支持字节码兼容性和演进

- [ ] **魔数与版本头**
  ```
  字节码文件格式:
  [0-3]   魔数 "KAUB"
  [4-5]   主版本号 (u16)
  [6-7]   次版本号 (u16)
  [8-...] 实际字节码
  ```

- [ ] **版本校验**
  - [ ] 加载时检查版本兼容性
  - [ ] 不兼容时给出清晰错误

---

## ⭐ 中优先级（下一迭代）

### 3. @ProgramStart 装饰器

**目标**: 标记程序入口模块

```kaubo
@ProgramStart
module main {
    import std;
    
    pub var run = || {
        std.print("Hello, World!");
        return 0;
    };
}
```

- [ ] Parser 支持装饰器语法
- [ ] 编译期检查唯一性
- [ ] 运行时自动调用 `run` 函数

---

### 4. 浮点数字面量

**目标**: 支持浮点数字面量

```kaubo
var pi = 3.14159;
var negative = -2.5;
var scientific = 1.5e10;
```

- [ ] Lexer 添加 `LiteralFloat` Token
- [ ] Parser 支持浮点数解析
- [ ] 更新测试用例

---

### 5. 代码清理

- [ ] 删除 Parser 中未使用的 Print 语句处理代码
- [ ] 修复编译器警告
- [ ] 统一错误类型命名

---

## 🌙 低优先级（未来）

### 6. 垃圾回收

- [ ] 标记-清除 GC 实现
- [ ] 增量回收支持

### 7. 性能优化

- [ ] 热点函数缓存
- [ ] 内联小函数

### 8. 调试支持

- [ ] 断点支持
- [ ] 单步执行
- [ ] 变量查看

### 9. 更多标准库函数

- [ ] 字符串操作（length, substring, concat）
- [ ] 列表操作（push, pop, length）
- [ ] 文件 I/O

---

## ✅ 已完成

- [x] 模块静态化（ShapeID 系统）
- [x] 显式导入 `import std;`
- [x] 标准库基础功能（print, sqrt, PI, E 等）
- [x] 删除 print 关键字
- [x] 测试框架（180+ 测试）
- [x] `not` 操作符实现
- [x] `!=` 操作符实现

---

## 已知设计问题

### 高优先级

1. **测试机制缺失** → ✅ 已解决
2. **错误处理不完善** → 🚧 进行中
3. **语义化版本** → ⏸️ 待开始

### 中优先级

4. **@ProgramStart 装饰器** - 设计已完成但未实现
5. **浮点数修复** - 字面量不支持
6. **GC 缺失** - 目前只分配不回收

---

*最后更新: 2026-02-10*
