# Kaubo 开发任务清单

> 记录设计问题、技术债务和开发计划

## 🔥 高优先级（当前迭代）

### 1. 测试机制 ⭐⭐⭐

**目标**: 建立完善的自动化测试体系

- [ ] **单元测试框架**
  - [ ] 添加 `tests/` 目录结构
  - [ ] Value 类型测试（NaN Boxing 正确性）
  - [ ] 对象系统测试（ObjModule, ObjClosure 等）
  
- [ ] **集成测试**
  - [ ] 端到端测试：编译 + 执行 + 验证输出
  - [ ] 标准库功能测试
  - [ ] 语法特性测试（条件、循环、函数等）

- [ ] **测试工具**
  - [ ] 创建 `TestRunner` 简化测试编写
  - [ ] 支持预期输出比对
  - [ ] 支持运行时错误测试

**参考**: 使用 Rust 内置 `#[test]` + `insta` crate 做快照测试

---

### 2. 错误处理完善 ⭐⭐⭐

**目标**: 提供清晰、有上下文的错误信息

- [ ] **编译错误改进**
  - [ ] 添加行号、列号信息到 Token
  - [ ] 格式化错误输出（类似 Rust 的错误格式）
  - [ ] 常见错误提示（如未导入的模块）

- [ ] **运行时错误**
  - [ ] 添加调用堆栈追踪
  - [ ] 保留源码位置信息在字节码中

---

### 3. 字节码版本号 ⭐⭐⭐

**目标**: 支持字节码兼容性和演进

- [ ] **魔数与版本头**
  ```
  字节码文件格式:
  [0-3]   魔数 "KAUB"
  [4-5]   主版本号 (u16)
  [6-7]   次版本号 (u16)
  [8-...] 实际字节码
  ```

- [ ] **版本校验**
  - [ ] 加载时检查版本兼容性
  - [ ] 不兼容时给出清晰错误

---

## ⭐ 中优先级（下一迭代）

### 4. @ProgramStart 装饰器

**目标**: 标记程序入口模块

```kaubo
@ProgramStart
module main {
    import std;
    
    pub var run = || {
        std.print("Hello, World!");
        return 0;
    };
}
```

- [ ] Parser 支持装饰器语法
- [ ] 编译期检查唯一性
- [ ] 运行时自动调用 `run` 函数

---

### 5. 浮点数修复

- [ ] 浮点数相等比较使用 epsilon
- [ ] sqrt 等函数参数校验（负数处理）

---

### 6. 代码清理

- [ ] 删除 Parser 中未使用的 Print 语句处理代码
- [ ] 修复编译器警告
- [ ] 统一错误类型命名

---

## 🌙 低优先级（未来）

### 7. 垃圾回收

- [ ] 标记-清除 GC 实现
- [ ] 增量回收支持

### 8. 性能优化

- [ ] 热点函数缓存
- [ ] 内联小函数

### 9. 调试支持

- [ ] 断点支持
- [ ] 单步执行
- [ ] 变量查看

---

## ✅ 已完成

- [x] 模块静态化（ShapeID 系统）
- [x] 显式导入 `import std;`
- [x] 标准库基础功能（print, sqrt, PI, E 等）
- [x] 删除 print 关键字

---

*最后更新: 2026-02-10*
