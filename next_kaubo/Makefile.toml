# Kaubo Language - cargo-make 配置文件
# 安装: cargo install cargo-make
# 使用: cargo make <task>
#
# 常用任务:
#   cargo make run                      # 运行默认项目 (examples/hello)
#   cargo make run PROJECT=examples/fib # 运行指定项目
#   cargo make test                     # 运行所有测试
#   cargo make build                    # 构建 release 版本
#   cargo make check                    # 检查代码
#   cargo make cov-open                 # 生成并打开覆盖率报告
#
# 项目配置:
#   每个项目通过 package.json 配置编译器行为 (log_level, show_source 等)

[config]
default_to_workspace = false

# ============== 默认任务 ==============

[tasks.default]
alias = "test"

# ============== 构建任务 ==============

[tasks.build]
description = "构建 CLI release 版本"
command = "cargo"
args = ["build", "-p", "kaubo-cli", "--release"]

[tasks.build-all]
description = "构建所有 workspace 成员"
command = "cargo"
args = ["build", "--workspace"]

# ============== 测试任务 ==============

[tasks.test]
description = "运行所有测试"
command = "cargo"
args = ["test", "--workspace"]

[tasks.test-core]
description = "运行 kaubo-core 测试"
command = "cargo"
args = ["test", "-p", "kaubo-core"]

[tasks.test-api]
description = "运行 kaubo-api 测试"
command = "cargo"
args = ["test", "-p", "kaubo-api"]

[tasks.test-log]
description = "运行 kaubo-log 测试"
command = "cargo"
args = ["test", "-p", "kaubo-log", "--all-features"]

[tasks.test-cli]
description = "运行 kaubo-cli 测试"
command = "cargo"
args = ["test", "-p", "kaubo-cli"]

[tasks.test-watch]
description = "持续测试 (需 cargo-watch)"
command = "cargo"
args = ["watch", "-x", "test"]

# ============== 代码质量任务 ==============

[tasks.check]
description = "检查代码"
command = "cargo"
args = ["check", "--workspace"]

[tasks.check-all]
description = "检查所有目标 (包括测试)"
command = "cargo"
args = ["check", "--workspace", "--all-targets"]

[tasks.fmt]
description = "格式化代码"
command = "cargo"
args = ["fmt", "--all"]

[tasks.fmt-check]
description = "检查代码格式"
command = "cargo"
args = ["fmt", "--all", "--", "--check"]

[tasks.clippy]
description = "运行 clippy (允许警告)"
command = "cargo"
args = ["clippy", "--workspace"]

[tasks.lint]
description = "运行 clippy 严格检查 (-D warnings)"
command = "cargo"
args = ["clippy", "--workspace", "--", "-D", "warnings"]

[tasks.quality]
description = "运行全套代码质量检查"
dependencies = ["fmt-check", "check-all", "clippy", "test"]

# ============== 覆盖率任务 ==============

[tasks.cov]
description = "生成覆盖率报告 (终端输出，需 nightly)"
script = "rustup run nightly cargo llvm-cov --workspace --branch --all-features"

[tasks.cov-html]
description = "生成 HTML 覆盖率报告"
script = "rustup run nightly cargo llvm-cov --workspace --branch --all-features --html --output-dir target/llvm-cov"

[tasks.cov-open]
description = "生成并打开 HTML 覆盖率报告"
script = "rustup run nightly cargo llvm-cov --workspace --branch --all-features --html --output-dir target/llvm-cov --open"

[tasks.cov-log]
description = "kaubo-log 覆盖率报告 (终端)"
script = "rustup run nightly cargo llvm-cov -p kaubo-log --branch --all-features"

[tasks.cov-log-html]
description = "kaubo-log 覆盖率 HTML 报告"
script = "rustup run nightly cargo llvm-cov -p kaubo-log --branch --all-features --html --output-dir target/llvm-cov/kaubo-log"

[tasks.cov-log-open]
description = "打开 kaubo-log 覆盖率报告"
script = "rustup run nightly cargo llvm-cov -p kaubo-log --branch --all-features --html --output-dir target/llvm-cov/kaubo-log --open"

# ============== CLI 运行任务 ==============
# 项目配置通过 package.json 控制

[tasks.run]
description = "运行项目 (默认 examples/hello)"
command = "cargo"
args = ["run", "-p", "kaubo-cli", "--", "examples/hello/package.json"]

[tasks.run-fib]
description = "运行斐波那契示例"
command = "cargo"
args = ["run", "-p", "kaubo-cli", "--", "examples/fib/package.json"]

[tasks.run-calc]
description = "运行计算器示例"
command = "cargo"
args = ["run", "-p", "kaubo-cli", "--", "examples/calc/package.json"]

[tasks.run-release]
description = "Release 模式运行 (默认 examples/hello)"
command = "cargo"
args = ["run", "-p", "kaubo-cli", "--release", "--", "examples/hello/package.json"]

# ============== 文档任务 ==============

[tasks.doc]
description = "生成文档"
command = "cargo"
args = ["doc", "--workspace", "--no-deps"]

[tasks.doc-open]
description = "生成并打开文档"
command = "cargo"
args = ["doc", "--workspace", "--no-deps", "--open"]

# ============== 清理任务 ==============

[tasks.clean]
description = "清理构建文件"
command = "cargo"
args = ["clean"]

[tasks.clean-all]
description = "深度清理 (包括覆盖率数据)"
script = "cargo clean && Remove-Item -Recurse -Force target/llvm-cov -ErrorAction SilentlyContinue"

# ============== 安装/设置任务 ==============

[tasks.install-tools]
description = "显示安装说明"
script = "echo '请手动运行以下命令:' && echo '1. cargo install cargo-make' && echo '2. cargo install cargo-llvm-cov' && echo '3. rustup install nightly'"

[tasks.check-env]
description = "检查开发环境"
command = "rustc"
args = ["--version"]

# ============== CI/自动化任务 ==============

[tasks.ci]
description = "CI 全套检查"
dependencies = ["fmt-check", "check-all", "clippy", "test", "build"]
