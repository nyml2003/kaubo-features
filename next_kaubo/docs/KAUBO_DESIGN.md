# Kaubo ç¼–è¯‘å™¨ - å®Œæ•´è®¾è®¡æ–‡æ¡£

> æœ¬æ–‡æ¡£æ˜¯ Kaubo è¯­è¨€ç¼–è¯‘å™¨çš„å®Œæ•´è®¾è®¡æ–‡æ¡£ï¼Œæ¶µç›–æ¶æ„ã€å®ç°æ–¹æ¡ˆå’Œå¼€å‘è·¯çº¿å›¾ã€‚

---

## ç›®å½•

1. [é¡¹ç›®æ¦‚è¿°](#1-é¡¹ç›®æ¦‚è¿°)
2. [å¿«é€Ÿå¼€å§‹](#2-å¿«é€Ÿå¼€å§‹)
3. [æŠ€æœ¯æ¶æ„](#3-æŠ€æœ¯æ¶æ„)
4. [å½“å‰çŠ¶æ€](#4-å½“å‰çŠ¶æ€)
5. [å¼€å‘è·¯çº¿å›¾](#5-å¼€å‘è·¯çº¿å›¾)
6. [å­—èŠ‚ç è®¾è®¡](#6-å­—èŠ‚ç è®¾è®¡)
7. [é«˜çº§ç‰¹æ€§è®¾è®¡](#7-é«˜çº§ç‰¹æ€§è®¾è®¡)
8. [ç±»å‹ç³»ç»Ÿè®¾è®¡](#8-ç±»å‹ç³»ç»Ÿè®¾è®¡)
9. [æµ‹è¯•ä¸è´¨é‡](#9-æµ‹è¯•ä¸è´¨é‡)
10. [å·²çŸ¥é—®é¢˜](#10-å·²çŸ¥é—®é¢˜)

---

## 1. é¡¹ç›®æ¦‚è¿°

**Kaubo** æ˜¯ä¸€ä¸ªç°ä»£ç¼–ç¨‹è¯­è¨€çš„å®Œæ•´ç¼–è¯‘å™¨å®ç°ï¼Œé‡‡ç”¨ Rust ç¼–å†™ï¼ŒåŒ…å«ç¼–è¯‘å™¨å‰ç«¯ï¼ˆè¯æ³•åˆ†æã€è¯­æ³•åˆ†æã€è¯­ä¹‰åˆ†æï¼‰å’Œç¼–è¯‘å™¨åç«¯ï¼ˆå­—èŠ‚ç ç”Ÿæˆã€è™šæ‹Ÿæœºæ‰§è¡Œï¼‰ã€‚

| å±æ€§ | å€¼ |
|------|-----|
| åç§° | next_kaubo |
| ç‰ˆæœ¬ | 0.1.0 |
| è¯­è¨€ | Rust (Edition 2024) |
| æ¶æ„ | çŠ¶æ€æœº Lexer â†’ Pratt Parser â†’ ç±»å‹æ£€æŸ¥ â†’ å­—èŠ‚ç ç¼–è¯‘ â†’ æ ˆå¼ VM |

### 1.1 é¡¹ç›®ç»“æ„

```
src/
â”œâ”€â”€ main.rs                 # ç¨‹åºå…¥å£
â”œâ”€â”€ lib.rs                  # åº“å¯¼å‡º
â”œâ”€â”€ compiler/               # ç¼–è¯‘å™¨æ¨¡å—ï¼ˆå‰ç«¯ï¼‰
â”‚   â”œâ”€â”€ lexer/              # Kaubo è¯­è¨€ä¸“ç”¨è¯æ³•åˆ†æå™¨
â”‚   â”‚   â”œâ”€â”€ builder.rs      # Lexer æ„å»ºå™¨
â”‚   â”‚   â””â”€â”€ token_kind.rs   # Token ç±»å‹å®šä¹‰
â”‚   â”œâ”€â”€ parser/             # è¯­æ³•åˆ†æå™¨
â”‚   â”‚   â”œâ”€â”€ parser.rs       # Pratt è§£æå™¨å®ç°
â”‚   â”‚   â”œâ”€â”€ expr.rs         # è¡¨è¾¾å¼ AST
â”‚   â”‚   â”œâ”€â”€ stmt.rs         # è¯­å¥ AST
â”‚   â”‚   â”œâ”€â”€ module.rs       # æ¨¡å— AST
â”‚   â”‚   â”œâ”€â”€ error.rs        # é”™è¯¯ç±»å‹
â”‚   â”‚   â””â”€â”€ utils.rs        # å·¥å…·å‡½æ•°
â”‚   â””â”€â”€ ir/                 # ä¸­é—´è¡¨ç¤ºï¼ˆé¢„ç•™ï¼‰
â”œâ”€â”€ kit/                    # é€šç”¨å·¥å…·åŒ…ï¼ˆå¯å¤ç”¨ç»„ä»¶ï¼‰
â”‚   â”œâ”€â”€ lexer/              # é€šç”¨è¯æ³•åˆ†ææ¡†æ¶
â”‚   â”‚   â”œâ”€â”€ c_lexer.rs      # é€šç”¨ Lexer å®ç°
â”‚   â”‚   â”œâ”€â”€ types.rs        # Token/Coordinate ç±»å‹
â”‚   â”‚   â””â”€â”€ state_machine/  # çŠ¶æ€æœºæ¡†æ¶
â”‚   â””â”€â”€ ring_buffer/        # ç¯å½¢ç¼“å†²åŒº
â””â”€â”€ runtime/                # è¿è¡Œæ—¶ï¼ˆåç«¯ï¼‰
    â”œâ”€â”€ bytecode/           # å­—èŠ‚ç å®šä¹‰
    â”‚   â”œâ”€â”€ mod.rs          # OpCode å®šä¹‰
    â”‚   â””â”€â”€ chunk.rs        # å­—èŠ‚ç å—
    â”œâ”€â”€ vm.rs               # è™šæ‹Ÿæœºï¼ˆæ ˆå¼æ‰§è¡Œå¼•æ“ï¼‰
    â”œâ”€â”€ value.rs            # NaN Boxing å€¼è¡¨ç¤º
    â””â”€â”€ compiler.rs         # AST â†’ Bytecode ç¼–è¯‘å™¨
```

---

## 2. å¿«é€Ÿå¼€å§‹

### 2.1 æ„å»ºä¸è¿è¡Œ

```bash
# æ„å»ºé¡¹ç›®
cargo build --release

# è¿è¡Œæµ‹è¯•ï¼ˆ211 ä¸ªæµ‹è¯•ï¼‰
cargo test

# è¿è¡Œç¤ºä¾‹ç¨‹åº
cargo run -- assets/a.txt
```

### 2.2 ç¤ºä¾‹ä»£ç 

```kaubo
// å½“å‰æ”¯æŒçš„è¯­æ³•
var x = 5;
var y = x + 3;
return y;  // è¿”å› 8
```

---

## 3. æŠ€æœ¯æ¶æ„

### 3.1 æ•´ä½“æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æºä»£ç    â”‚ â†’ â”‚  Lexer  â”‚ â†’ â”‚  Parser â”‚ â†’ â”‚ Compilerâ”‚ â†’ â”‚   VM    â”‚
â”‚  .kaubo â”‚    â”‚  è¯æ³•   â”‚    â”‚  è¯­æ³•   â”‚    â”‚ å­—èŠ‚ç   â”‚    â”‚  æ‰§è¡Œ   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              AST           Bytecode        è¿è¡Œç»“æœ
```

### 3.2 è¯æ³•åˆ†æå™¨

é‡‡ç”¨**çŠ¶æ€æœºé©±åŠ¨**æ¶æ„ï¼Œæ”¯æŒæµå¼è¾“å…¥å’Œ UTF-8ã€‚

**æ ¸å¿ƒæµç¨‹**:
```
è¾“å…¥å­—èŠ‚æµ â†’ ç¯å½¢ç¼“å†²åŒº â†’ UTF-8è§£ç  â†’ çŠ¶æ€æœºç«äº‰åŒ¹é… â†’ Tokenè¾“å‡º
```

**æ”¯æŒçš„ Token ç±»å‹**:

| ç±»åˆ« | Token |
|------|-------|
| å…³é”®å­— | `var`, `if`, `else`, `elif`, `while`, `for`, `return`, `true`, `false`, `null`, `and`, `or`, `not` ç­‰ |
| å­—é¢é‡ | `LiteralInteger`, `LiteralString` |
| è¿ç®—ç¬¦ | `==`, `!=`, `>=`, `<=`, `>`, `<`, `+`, `-`, `*`, `/`, `=`, `.`, `\|` ç­‰ |
| åˆ†éš”ç¬¦ | `(`, `)`, `{`, `}`, `[`, `]`, `,`, `;`, `:` |

### 3.3 è¯­æ³•åˆ†æå™¨

é‡‡ç”¨ **Pratt è§£æç®—æ³•**ï¼ˆTop-down operator precedenceï¼‰ã€‚

**ä¼˜å…ˆçº§è¡¨**ï¼ˆä»é«˜åˆ°ä½ï¼‰:

| ä¼˜å…ˆçº§ | è¿ç®—ç¬¦ | è¯´æ˜ |
|--------|--------|------|
| 450 | `not` | ä¸€å…ƒé€»è¾‘é |
| 400 | `.` | æˆå‘˜è®¿é—® |
| 300 | `*`, `/` | ä¹˜é™¤ |
| 200 | `+`, `-` | åŠ å‡ |
| 100 | `==`, `!=`, `>`, `<`, `>=`, `<=` | æ¯”è¾ƒ |
| 80 | `and` | é€»è¾‘ä¸ |
| 70 | `\|` | ç®¡é“ |
| 60 | `or` | é€»è¾‘æˆ– |
| 50 | `=` | èµ‹å€¼ |

**AST ç»“æ„**:

```rust
// è¡¨è¾¾å¼
pub enum ExprKind {
    LiteralInt(LiteralInt),       // 42
    LiteralString(LiteralString), // "hello"
    LiteralTrue, LiteralFalse, LiteralNull,
    LiteralList(LiteralList),     // [1, 2, 3]
    Binary(Binary),               // a + b
    Unary(Unary),                 // -a, not b
    Grouping(Grouping),           // (a + b)
    VarRef(VarRef),               // x
    FunctionCall(FunctionCall),   // foo(a, b)
    Assign(Assign),               // x = 5
    Lambda(Lambda),               // |x| { x + 1 }
    MemberAccess(MemberAccess),   // obj.field
}

// è¯­å¥
pub enum StmtKind {
    Expr(ExprStmt),               // a + b;
    Empty,                        // ;
    Block(BlockStmt),             // { ... }
    VarDecl(VarDeclStmt),         // var x = 5;
    If(IfStmt),                   // if/elif/else
    While(WhileStmt),             // while (cond) { ... }
    For(ForStmt),                 // for (i) in (list) { ... }
    Return(ReturnStmt),           // return value;
}
```

### 3.4 ç¼–è¯‘å™¨åç«¯

**ç¼–è¯‘æµç¨‹**:
```
AST â†’ ç±»å‹æ£€æŸ¥ â†’ å­—èŠ‚ç ç¼–è¯‘ â†’ å­—èŠ‚ç å—(Chunk) â†’ VM æ‰§è¡Œ
```

**æ ¸å¿ƒç»„ä»¶**:
- **Type Checker**: ç±»å‹æ£€æŸ¥ä¸æ¨æ–­ï¼ˆPhase 2.7ï¼‰
- **Compiler**: AST åˆ°å­—èŠ‚ç çš„ç¼–è¯‘
- **Chunk**: å­—èŠ‚ç å—ï¼ˆæŒ‡ä»¤ + å¸¸é‡æ±  + è¡Œå·ï¼‰
- **VM**: æ ˆå¼è™šæ‹Ÿæœºï¼ˆå€¼æ ˆ + è°ƒç”¨å¸§æ ˆï¼‰
- **Value**: NaN Boxing å€¼è¡¨ç¤ºï¼ˆSMI + Float + Special + Heapï¼‰

---

## 4. å½“å‰çŠ¶æ€

### 4.1 å·²å®ŒæˆåŠŸèƒ½

| åŠŸèƒ½ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| è¯æ³•åˆ†æå™¨ | âœ… | çŠ¶æ€æœºé©±åŠ¨ï¼Œå®Œæ•´ Token æ”¯æŒ |
| è¯­æ³•åˆ†æå™¨ | âœ… | Pratt è§£æå™¨ï¼Œè¡¨è¾¾å¼ + è¯­å¥ |
| å­—èŠ‚ç  VM | âœ… | æ ˆå¼æ‰§è¡Œï¼ŒåŸºç¡€æŒ‡ä»¤é›† |
| å€¼è¡¨ç¤º | âœ… | NaN Boxingï¼ˆSMI/Float/Special/Functionï¼‰|
| å±€éƒ¨å˜é‡ | âœ… | LoadLocal/StoreLocal æŒ‡ä»¤ |
| å˜é‡ç¼–è¯‘ | âœ… | var å£°æ˜ã€è¯»å†™ã€èµ‹å€¼ |
| æ§åˆ¶æµ | âœ… | if/elif/elseã€whileã€break/continue |
| Lambda å‡½æ•° | âœ… | å‡½æ•°å®šä¹‰ã€è°ƒç”¨ã€é€’å½’ï¼ˆé˜¶æ®µä¸€ï¼Œæ— é—­åŒ…ï¼‰|
| å­—ç¬¦ä¸²æ”¯æŒ | âœ… | å­—ç¬¦ä¸²å­—é¢é‡ã€å­—ç¬¦ä¸²å¯¹è±¡ |

### 4.2 è¿›è¡Œä¸­

**Phase 2.3**: é—­åŒ…æ”¯æŒï¼ˆUpvalue æœºåˆ¶ï¼‰ğŸš§
**Phase 2.6**: æ¨¡å—ç³»ç»Ÿï¼ˆå•æ–‡ä»¶å†…ï¼Œå«å†…ç½®æ¨¡å—ï¼‰â³

### 4.3 æµ‹è¯•çŠ¶æ€

- **å•å…ƒæµ‹è¯•**: 211 ä¸ªï¼Œå…¨éƒ¨é€šè¿‡ âœ…
- **è¡Œè¦†ç›–ç‡**: 82.11%

---

## 5. å¼€å‘è·¯çº¿å›¾

### æ•´ä½“è§„åˆ’

```
Phase 1: æµ‹è¯•ä¸ä¿®å¤ âœ… (å·²å®Œæˆ)
    â†“
Phase 2: æ ¸å¿ƒåŠŸèƒ½å®ç° ğŸš§ (è¿›è¡Œä¸­)
    â”œâ”€ 2.2: å˜é‡ç³»ç»Ÿä¸æ§åˆ¶æµ (4å‘¨) - W1-W3 âœ…, W4 â³
    â”œâ”€ 2.2.5: Lambda å‡½æ•°æ”¯æŒ (2å‘¨) - é˜¶æ®µä¸€ â³
    â”œâ”€ 2.3: é—­åŒ…æ”¯æŒ (3å‘¨) â³
    â”œâ”€ 2.4: åç¨‹ä¸è¿­ä»£å™¨ (4å‘¨) â³
    â”œâ”€ 2.5: Result ç±»å‹ä¸é”™è¯¯å¤„ç† (3å‘¨) â³
    â”œâ”€ 2.6: æ¨¡å—ç³»ç»Ÿä¸æ ‡å‡†åº“ (2å‘¨) ğŸš§
    â”œâ”€ 2.7: ä¸¥æ ¼ç±»å‹ç³»ç»Ÿ (2.5å‘¨) â³
    â””â”€ 2.8: GC ä¸ä¼˜åŒ– (2å‘¨) â³
    â†“
Phase 3: å¤šæ–‡ä»¶æ¨¡å—ä¸åŒ…ç®¡ç† â³
    â†“
Phase 4: æ€§èƒ½ä¼˜åŒ–ï¼ˆJITç­‰ï¼‰â³
```

### Phase 2.2: å˜é‡ç³»ç»Ÿä¸æ§åˆ¶æµ (4å‘¨)

| å‘¨æ¬¡ | ä»»åŠ¡ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|------|
| W1 | å±€éƒ¨å˜é‡è¡¨è®¾è®¡ | âœ… | æ ˆå¸§ç»“æ„ã€LoadLocal/StoreLocal æŒ‡ä»¤ |
| W2 | å˜é‡ç¼–è¯‘ | âœ… | var å£°æ˜ã€å˜é‡è¯»å†™ã€èµ‹å€¼ |
| W3 | æ§åˆ¶æµç¼–è¯‘ | âœ… | if/elif/elseã€while å¾ªç¯ã€break/continue |
| W4 | for-in åŸºç¡€ | ğŸš§ | åˆ—è¡¨å­—é¢é‡ã€è¿­ä»£å™¨åè®®ã€for-in å¾ªç¯ |

#### W4 è¯¦ç»†è®¾è®¡

**ç›®æ ‡**: å®ç°åˆ—è¡¨å­—é¢é‡å’ŒåŸºäºè¿­ä»£å™¨åè®®çš„ for-in å¾ªç¯

**è¯­æ³•**:
```kaubo
// åˆ—è¡¨å­—é¢é‡
var list = [1, 2, 3, 4, 5];
var empty = [];

// for-in å¾ªç¯ï¼ˆä½¿ç”¨è¿­ä»£å™¨åè®®ï¼‰
var sum = 0;
for item in list {
    sum = sum + item;
}
print sum;  // 15

// åˆ—è¡¨ç´¢å¼•è®¿é—®
var first = list[0];
```

**è¿­ä»£å™¨åè®®**:
```
è¿­ä»£å™¨å¯¹è±¡å¿…é¡»å®ç° next() æ–¹æ³•ï¼Œè¿”å›ï¼š
- Some(value) - æœ‰ä¸‹ä¸€ä¸ªå€¼ï¼Œç»§ç»­è¿­ä»£
- None - è¿­ä»£ç»“æŸ

for item in iterable { body }
â†“ ç¼–è¯‘ä¸º â†“
var $iter = iterable.iter();  // è·å–è¿­ä»£å™¨
while (true) {
    var $next = $iter.next();
    if ($next.is_none()) break;
    var item = $next.unwrap();
    body;
}
```

**å®ç°èŒƒå›´**:
- âœ… åˆ—è¡¨å­—é¢é‡ `[1, 2, 3]` - `BuildList` æŒ‡ä»¤
- âœ… åˆ—è¡¨ç´¢å¼•è¯»å– `list[i]` - `IndexGet` æŒ‡ä»¤
- âœ… è¿­ä»£å™¨åè®® - `iter()` æ–¹æ³•ã€`next()` æ–¹æ³•
- âœ… for-in å¾ªç¯ - åŸºäºè¿­ä»£å™¨åè®®
- âœ… åŸç”Ÿè¿­ä»£å™¨å¯¹è±¡ - `ListIterator`
- âŒ èŒƒå›´è¡¨è¾¾å¼ `0..10` - æš‚ä¸å®ç°
- âŒ ç”Ÿæˆå™¨/yield - ä¾èµ– Phase 2.4 åç¨‹
- âŒ è‡ªå®šä¹‰è¿­ä»£å™¨ï¼ˆç”¨æˆ·å®ç°ï¼‰- æš‚ä¸å¼€æ”¾

**æ–°å¢å­—èŠ‚ç **:
- `BuildList(u8)` - ä»æ ˆé¡¶ n ä¸ªå…ƒç´ åˆ›å»ºåˆ—è¡¨
- `IndexGet` - åˆ—è¡¨ç´¢å¼•è¯»å–
- `CallMethod(u8)` - æ–¹æ³•è°ƒç”¨ï¼ˆè°ƒç”¨ iter/next/unwrap/is_noneï¼‰

**ä¸åç¨‹çš„å…³ç³»**:
- å½“å‰ï¼šè¿­ä»£å™¨æ˜¯åŸç”Ÿå¯¹è±¡ï¼ˆRust å®ç°ï¼‰ï¼Œæ‰‹åŠ¨ç»´æŠ¤ç´¢å¼•çŠ¶æ€
- æœªæ¥ï¼šåç¨‹ yield å¯ç”¨äºå®ç°æƒ°æ€§ç”Ÿæˆå™¨è¿­ä»£å™¨
- åè®®å…¼å®¹ï¼šåç¨‹ç”Ÿæˆå™¨ä¹Ÿä¼šéµå¾ªç›¸åŒçš„ `iter()`/`next()` åè®®

### Phase 2.2.5: Lambda å‡½æ•°æ”¯æŒ (2å‘¨)

| é˜¶æ®µ | ä»»åŠ¡ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|------|
| é˜¶æ®µä¸€ | åŸºç¡€ Lambda | âœ… | å‡½æ•°å®šä¹‰ã€è°ƒç”¨ã€é€’å½’ï¼ˆæ— é—­åŒ…ï¼‰|
| é˜¶æ®µäºŒ | é—­åŒ…æ”¯æŒ | â³ | Upvalueã€å˜é‡æ•è·ï¼ˆPhase 2.3ï¼‰|

### Phase 2.2.5: Lambda å‡½æ•°æ”¯æŒ (2å‘¨)

#### é˜¶æ®µä¸€ï¼šåŸºç¡€ Lambda æ”¯æŒï¼ˆä¸åŒ…å«é—­åŒ…ï¼‰

**ç›®æ ‡**: å®ç°åŸºæœ¬çš„ lambda å‡½æ•°å®šä¹‰å’Œè°ƒç”¨ï¼Œæš‚ä¸æ”¯æŒå˜é‡æ•è·

**å­—èŠ‚ç å±‚é¢**:
- æ·»åŠ  `Closure` OpCodeï¼šç”¨äºåˆ›å»ºå‡½æ•°å¯¹è±¡
- æ·»åŠ  `Call` æŒ‡ä»¤çš„å®ç°ï¼šæ”¯æŒå‡½æ•°è°ƒç”¨
- æš‚ä¸æ·»åŠ  `GetUpvalue` å’Œ `SetUpvalue` æŒ‡ä»¤ï¼ˆé—­åŒ…ç›¸å…³ï¼‰

**å€¼è¡¨ç¤ºå±‚é¢**:
- åœ¨ Value ä¸­æ·»åŠ å‡½æ•°å¯¹è±¡ç±»å‹æ”¯æŒ
- æ·»åŠ  `is_function()` å’Œ `as_function()` æ–¹æ³•
- æ·»åŠ  `Value::function()` æ„é€ æ–¹æ³•

**å¯¹è±¡ç³»ç»Ÿ**:
- æ·»åŠ  `ObjFunction` ç»“æ„ä½“ï¼šå­˜å‚¨å‡½æ•°çš„å­—èŠ‚ç å’Œå‚æ•°æ•°é‡
- æ·»åŠ  `ObjClosure` ç»“æ„ä½“ï¼ˆé¢„ç•™ï¼Œæš‚ä¸å®ç°ï¼‰
- æ·»åŠ ç®€å•çš„å¯¹è±¡åˆ†é…å™¨ï¼ˆä½¿ç”¨ `Box` æˆ– `Rc`ï¼‰

**ç¼–è¯‘å™¨å±‚é¢**:
- å®ç° `compile_lambda()` æ–¹æ³•ï¼š
  - åˆ›å»ºæ–°çš„ç¼–è¯‘å™¨å®ä¾‹ç¼–è¯‘å‡½æ•°ä½“
  - ç”Ÿæˆå‡½æ•°å¯¹è±¡
  - å°†å‡½æ•°å¯¹è±¡ä½œä¸ºå¸¸é‡åŠ è½½åˆ°æ ˆä¸Š
- å®ç° `compile_function_call()` æ–¹æ³•ï¼š
  - ç¼–è¯‘å‡½æ•°è¡¨è¾¾å¼
  - ç¼–è¯‘å‚æ•°è¡¨è¾¾å¼
  - ç”Ÿæˆ Call æŒ‡ä»¤

**è™šæ‹Ÿæœºå±‚é¢**:
- å®ç° `Call` æŒ‡ä»¤ï¼š
  - åˆ›å»ºæ–°çš„è°ƒç”¨å¸§
  - ä¼ é€’å‚æ•°
  - è·³è½¬åˆ°å‡½æ•°ä½“æ‰§è¡Œ
- å®ç° `Closure` æŒ‡ä»¤ï¼š
  - ä»å¸¸é‡æ± åŠ è½½å‡½æ•°å¯¹è±¡
  - å‹å…¥æ ˆé¡¶
- å®ç°è°ƒç”¨å¸§ç®¡ç†ï¼š
  - ä¿å­˜/æ¢å¤è°ƒç”¨ä¸Šä¸‹æ–‡
  - å¤„ç†è¿”å›å€¼

**æµ‹è¯•ç”¨ä¾‹**:
- åŸºæœ¬å‡½æ•°å®šä¹‰å’Œè°ƒç”¨
- å¤šå‚æ•°å‡½æ•°
- åµŒå¥—å‡½æ•°ï¼ˆä¸æ•è·å˜é‡ï¼‰
- é€’å½’å‡½æ•°
- å‡½æ•°ä½œä¸ºå‚æ•°ä¼ é€’ï¼ˆä½†ä¸æ•è·å˜é‡ï¼‰

**é™åˆ¶è¯´æ˜ï¼ˆé˜¶æ®µä¸€ï¼‰**:
1. ä¸æ”¯æŒæ•è·å¤–éƒ¨å˜é‡ï¼ˆé—­åŒ…ï¼‰
2. ä¸æ”¯æŒåµŒå¥—å‡½æ•°è®¿é—®å¤–éƒ¨ä½œç”¨åŸŸå˜é‡
3. å‡½æ•°åªèƒ½è®¿é—®è‡ªå·±çš„å‚æ•°å’Œå±€éƒ¨å˜é‡
4. å‡½æ•°å¯ä»¥ä½œä¸ºå€¼ä¼ é€’ï¼Œä½†ä¸èƒ½æºå¸¦ç¯å¢ƒ

#### é˜¶æ®µäºŒï¼šé—­åŒ…æ”¯æŒï¼ˆåç»­å®ç°ï¼‰

**Upvalue ç³»ç»Ÿ**:
- æ·»åŠ  `ObjUpvalue` ç»“æ„ä½“
- å®ç° upvalue è§£æå’Œæ•è·
- æ·»åŠ  `GetUpvalue` å’Œ `SetUpvalue` æŒ‡ä»¤

**é—­åŒ…å¯¹è±¡**:
- å®Œå–„ `ObjClosure` å®ç°
- å®ç° upvalue ç®¡ç†

**ç¼–è¯‘å™¨å¢å¼º**:
- è§£æé—­åŒ…å˜é‡
- ç”Ÿæˆ upvalue è®¿é—®ä»£ç 

**è™šæ‹Ÿæœºå¢å¼º**:
- å®ç° upvalue è¯»å†™
- å¤„ç†é—­åŒ…ç”Ÿå‘½å‘¨æœŸ

### Phase 2.3: é—­åŒ…æ”¯æŒ (3å‘¨)

**æ–¹æ¡ˆ**: Lua é£æ ¼ Upvalue ç®€åŒ–ç‰ˆ

#### æ ¸å¿ƒè®¾è®¡

**1. Upvalue å¯¹è±¡ (`ObjUpvalue`)**
```rust
/// Upvalue å¯¹è±¡ - è¡¨ç¤ºå¯¹å¤–éƒ¨å˜é‡çš„å¼•ç”¨
pub struct ObjUpvalue {
    /// æŒ‡å‘å¤–éƒ¨å˜é‡çš„æŒ‡é’ˆï¼ˆæ ˆä¸Šæˆ–å·²å…³é—­ï¼‰
    location: *mut Value,
    /// å¦‚æœå˜é‡ç¦»å¼€æ ˆï¼Œè½¬å‚¨åˆ°è¿™é‡Œ
    closed: Option<Value>,
}
```

**2. é—­åŒ…å¯¹è±¡ (`ObjClosure`)**
```rust
/// é—­åŒ…å¯¹è±¡ - åŒ…å«å‡½æ•°å’Œæ•è·çš„ upvalues
pub struct ObjClosure {
    /// åŸå§‹å‡½æ•°
    function: *mut ObjFunction,
    /// æ•è·çš„ upvalues
    upvalues: Vec<*mut ObjUpvalue>,
}
```

**3. æ•è·ç­–ç•¥**
- **æŒ‰å¼•ç”¨æ•è·**ï¼ˆLua é£æ ¼ï¼‰ï¼šé—­åŒ…å†…å¤–å…±äº«åŒä¸€å˜é‡
- **ç«‹å³å †åˆ†é…**ï¼šåˆ›å»º upvalue æ—¶å³åˆ†é…å †å†…å­˜
- **å†™æ—¶å…³é—­**ï¼šå½“å¤–éƒ¨å‡½æ•°è¿”å›æ—¶ï¼Œå°†æ ˆä¸Šçš„å€¼å¤åˆ¶åˆ° upvalue çš„ `closed` å­—æ®µ

#### å®ç°æ­¥éª¤

**æ­¥éª¤ 1: æ•°æ®ç»“æ„** (ç¬¬ 1 å‘¨)
- æ·»åŠ  `ObjUpvalue` ç»“æ„ä½“
- å®Œå–„ `ObjClosure`ï¼ˆæ›¿æ¢ç›´æ¥ä½¿ç”¨ `ObjFunction`ï¼‰
- æ›´æ–° `Value` ç±»å‹æ ‡ç­¾ï¼šé—­åŒ… vs æ™®é€šå‡½æ•°

**æ­¥éª¤ 2: å­—èŠ‚ç æŒ‡ä»¤** (ç¬¬ 1-2 å‘¨)
- `GetUpvalue(u8)` - è¯»å– upvalue å€¼
- `SetUpvalue(u8)` - è®¾ç½® upvalue å€¼
- `CloseUpvalues(u8)` - å…³é—­æŒ‡å®šæ§½ä½ä»¥ä¸Šçš„æ‰€æœ‰ upvalueï¼ˆå‡½æ•°è¿”å›æ—¶ï¼‰

**æ­¥éª¤ 3: ç¼–è¯‘å™¨åˆ†æ** (ç¬¬ 2 å‘¨)
- **å˜é‡è§£æ**ï¼šåŒºåˆ†å±€éƒ¨å˜é‡ã€ upvalueã€å…¨å±€å˜é‡
- **æ•è·åˆ†æ**ï¼šéå†å‡½æ•°ä½“ï¼Œæ ‡è®°éœ€è¦æ•è·çš„å¤–éƒ¨å˜é‡
- **Upvalue è¡¨**ï¼šæ¯ä¸ªå‡½æ•°ç»´æŠ¤ä¸€ä¸ª upvalue æè¿°è¡¨ï¼ˆç´¢å¼•ã€åç§°ã€æ˜¯å¦æ¥è‡ªçˆ¶ä½œç”¨åŸŸï¼‰

**æ­¥éª¤ 4: VM æ”¯æŒ** (ç¬¬ 3 å‘¨)
- åˆ›å»ºé—­åŒ…æ—¶åˆ†é… upvalues
- å‡½æ•°è¿”å›æ—¶å…³é—­ upvalues
- åƒåœ¾å›æ”¶å¤„ç†ï¼ˆå¾ªç¯å¼•ç”¨æš‚ä¸å¤„ç†ï¼Œç•™åˆ° GC é˜¶æ®µï¼‰

#### å†…å­˜å¸ƒå±€ç¤ºä¾‹

```
å¤–éƒ¨å‡½æ•°æ ˆå¸§:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ local x: 5  â”‚ â† slot 0
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†‘
      â”‚ å¼•ç”¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Upvalue     â”‚â”€â”€â”€â”€â†’â”‚ location    â”‚â”€â”€â”€â”€â†’ slot 0 (æ ˆä¸Š)
â”‚ { location, â”‚     â”‚ closed: Noneâ”‚
â”‚   closed }  â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†‘
      â”‚ åŒ…å«
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Closure     â”‚
â”‚ { function, â”‚
â”‚   upvalues: â”‚
â”‚   [upvalue] }â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### éªŒæ”¶ä»£ç 
```kaubo
// åŸºç¡€æ•è·
var x = 5;
var f = || { return x; };
assert(f() == 5);

// ä¿®æ”¹å¤–éƒ¨å˜é‡
var y = 10;
var g = || { y = y + 1; return y; };
assert(g() == 11);
assert(y == 11);  // å¤–éƒ¨å˜é‡è¢«ä¿®æ”¹

// å¤šå˜é‡æ•è·
var a = 1;
var b = 2;
var h = || { return a + b; };
assert(h() == 3);

// åµŒå¥—é—­åŒ…
var outer = 100;
var f1 = || {
    var inner = 10;
    var f2 = || { return outer + inner; };
    return f2();
};
assert(f1() == 110);
```

### Phase 2.4: åç¨‹ä¸è¿­ä»£å™¨ (4å‘¨)

**æ–¹æ¡ˆ**: æ ˆå¼åç¨‹ + ç»Ÿä¸€è¿­ä»£å™¨åè®®

- åç¨‹æ ˆåŠ¨æ€å¢é•¿
- Yield/Resume åŒå‘é€šä¿¡
- é”™è¯¯ä¼ æ’­ä½œä¸ºå€¼äº§å‡º

### Phase 2.5: Result ç±»å‹ä¸é”™è¯¯å¤„ç† (3å‘¨)

**æ–¹æ¡ˆ**: Rust é£æ ¼ Resultï¼ˆæ—  `?` æ“ä½œç¬¦ï¼‰

```kaubo
fun divide(a: Int, b: Int) -> Result<Int, String> {
    if (b == 0) {
        return Err("division by zero");
    }
    return Ok(a / b);
}

match divide(10, 2) {
    Ok(v) => print(v),
    Err(e) => print(e),
}
```

### Phase 2.6: æ¨¡å—ç³»ç»Ÿä¸æ ‡å‡†åº“ (2å‘¨)

**æ–¹æ¡ˆ**: å•æ–‡ä»¶å†…æ¨¡å— + å†…ç½®æ ‡å‡†åº“ï¼Œè¯­æ³•ä¸å¤šæ–‡ä»¶æ¨¡å—å…¼å®¹

#### è®¾è®¡åŸåˆ™

| ç‰¹æ€§ | å†³ç­– |
|------|------|
| æ¨¡å—å®šä¹‰ | `module name { ... }` å—è¯­æ³• |
| å¯¼å‡ºæ§åˆ¶ | `pub` å…³é”®å­—æ ‡è®°å…¬å¼€æˆå‘˜ |
| å¯¼å…¥è¯­æ³• | `import module` / `from module import name` |
| å†…ç½®æ¨¡å— | `std.xxx` å‘½åç©ºé—´ï¼ŒRust åŸç”Ÿå®ç° |
| ä¸æ–‡ä»¶å…³ç³» | å½“å‰å•æ–‡ä»¶å†…ï¼Œæœªæ¥å¹³æ»‘æ‰©å±•åˆ°æ–‡ä»¶ç³»ç»Ÿ |

#### for-in å¾ªç¯ï¼ˆè¿­ä»£å™¨åè®®ï¼‰

**è¯­æ³•**:
```kaubo
for var item in list {
    print item;
}
// item åœ¨è¿™é‡Œä¸å¯è§ï¼ˆå—çº§ä½œç”¨åŸŸï¼‰
```

**å®ç°ç»†èŠ‚**:
- `var` å…³é”®å­—æ˜¾å¼å£°æ˜è¿­ä»£å˜é‡
- è¿­ä»£å˜é‡æ˜¯å—çº§ä½œç”¨åŸŸï¼Œå¾ªç¯å¤–ä¸å¯è®¿é—®
- è¿­ä»£å™¨å¯¹è±¡å­˜äºæ ˆä¸Šï¼Œä¸å ç”¨å±€éƒ¨å˜é‡åï¼ˆåŒ¿åï¼‰
- æ”¯æŒåµŒå¥— for å¾ªç¯

**ç¼–è¯‘ç­–ç•¥**:
```
for var item in iterable { body }
â†“
push(iterable.iter())     // è¿­ä»£å™¨åœ¨æ ˆä¸Šï¼Œä¸å‘½å
begin_scope
loop:
    item = next()         // è¿­ä»£å˜é‡ï¼Œå—çº§ä½œç”¨åŸŸ
    if item == null goto end
    body
    goto loop
end:
end_scope
pop()                     // æ¸…ç†è¿­ä»£å™¨
```

**å­—èŠ‚ç **:
- `GetIter` - ä»å¯è¿­ä»£å¯¹è±¡è·å–è¿­ä»£å™¨ï¼Œå‹æ ˆ
- `IterNext` - è·å–ä¸‹ä¸€ä¸ªå€¼ï¼Œnull è¡¨ç¤ºç»“æŸ

**ä¸ç”Ÿæˆå™¨çš„å…¼å®¹æ€§**:
å•æŒ‡ä»¤è®¾è®¡å¯¹ç”Ÿæˆå™¨å‹å¥½ï¼š
- åˆ—è¡¨è¿­ä»£å™¨ï¼šæ£€æŸ¥ç´¢å¼•ï¼Œè¿”å›å…ƒç´ æˆ– null
- ç”Ÿæˆå™¨ï¼šæ¢å¤åç¨‹æ‰§è¡Œåˆ° yieldï¼Œè¿”å›å€¼æˆ– nullï¼ˆæ‰§è¡Œå®Œï¼‰
- æ— éœ€é¢„æ‰§è¡Œ `HasNext`ï¼Œä¿æŒæƒ°æ€§æ±‚å€¼

#### å•æ–‡ä»¶æ¨¡å—è¯­æ³•

```kaubo
// ç”¨æˆ·å®šä¹‰æ¨¡å—
module math {
    // é»˜è®¤ private
    var PI = 3.14;
    
    // pub å¯¼å‡º
    pub fun add(a, b) { return a + b; }
    pub fun square(x) { return x * x; }
}

// ä½¿ç”¨æ¨¡å—
import math;
print math.add(1, 2);

// é€‰æ‹©æ€§å¯¼å…¥
from math import square;
print square(5);  // ç›´æ¥ä½¿ç”¨ï¼Œæ— éœ€å‰ç¼€
```

#### å†…ç½®æ ‡å‡†åº“æ¨¡å—

```kaubo
// å†…ç½®æ¨¡å—ç»Ÿä¸€ä½¿ç”¨ std. å‰ç¼€
import std.io;
import std.math;
import std.collections.List;

// ä½¿ç”¨
var list = List.new();
std.io.print(math.sqrt(16));
```

**å†…ç½®æ¨¡å—åˆ—è¡¨ï¼ˆè§„åˆ’ï¼‰**ï¼š
- `std.io` - è¾“å…¥è¾“å‡ºï¼ˆprint, read_line ç­‰ï¼‰
- `std.math` - æ•°å­¦å‡½æ•°ï¼ˆabs, sqrt, floor, sin/cos ç­‰ï¼‰
- `std.collections` - æ•°æ®ç»“æ„ï¼ˆList, Map, Setï¼‰
- `std.string` - å­—ç¬¦ä¸²å·¥å…·ï¼ˆlen, substring, concat ç­‰ï¼‰

#### å®ç°æ¶æ„

1. **ç¼–è¯‘æ—¶**ï¼šæ¨¡å—ç¼–è¯‘ä¸ºç‰¹æ®Šçš„å¯¹è±¡ï¼Œå¯¼å‡ºç¬¦å·è¡¨å­˜å‚¨ä¸ºå¸¸é‡
2. **è¿è¡Œæ—¶**ï¼šæ¨¡å—ä½œä¸ºä¸€ç­‰å…¬æ°‘ï¼ˆå¯¹è±¡ï¼‰ï¼Œå¯ä¼ é€’å’ŒåŠ¨æ€è®¿é—®
3. **å†…ç½®æ¨¡å—**ï¼šRust åŸç”Ÿå‡½æ•°æ³¨å†Œåˆ° VM çš„æ¨¡å—æ³¨å†Œè¡¨
4. **åŸç”Ÿå‡½æ•°**ï¼šæ–°å¢ `NativeFunction` ç±»å‹ï¼Œæ”¯æŒ Rust å®ç°çš„åŸç”Ÿå‡½æ•°

#### ä¸å¤šæ–‡ä»¶æ¨¡å—çš„å…¼å®¹æ€§

| å½“å‰ï¼ˆå•æ–‡ä»¶ï¼‰ | æœªæ¥ï¼ˆå¤šæ–‡ä»¶ï¼‰ | å…¼å®¹æ€§ |
|---------------|---------------|--------|
| `module math {}` | `math.kaubo` æ–‡ä»¶ | âœ… æ–‡ä»¶å³æ¨¡å— |
| `import math` | `import math`ï¼ˆæ–‡ä»¶ç³»ç»Ÿï¼‰ | âœ… è¯­æ³•ä¸€è‡´ |
| `from math import add` | `from math import add` | âœ… å®Œå…¨ä¸€è‡´ |
| `import std.io` | `import std.io`ï¼ˆå†…ç½®ä¼˜å…ˆï¼‰ | âœ… å†…ç½®ä¼˜å…ˆ |

**è¿ç§»è·¯å¾„**ï¼šæœªæ¥é‡åˆ° `import name`ï¼Œå…ˆæŸ¥å†…ç½®æ¨¡å— â†’ å†æŸ¥å½“å‰æ–‡ä»¶å†…æ¨¡å— â†’ æœ€åæŸ¥æ–‡ä»¶ç³»ç»Ÿ

### Phase 2.7: ä¸¥æ ¼ç±»å‹ç³»ç»Ÿ (2.5å‘¨)

**æ–¹æ¡ˆ**: æ¸è¿›å¼ç±»å‹ç³»ç»Ÿï¼Œæ”¯æŒç±»å‹æ¨æ–­å’Œæ˜¾å¼æ ‡æ³¨

### Phase 2.8: GC ä¸ä¼˜åŒ– (2å‘¨)

**æ–¹æ¡ˆ**: æ ‡è®°-æ¸…é™¤ GCï¼Œæ”¯æŒå¯¹è±¡ç”Ÿå‘½å‘¨æœŸç®¡ç†

**æ ¸å¿ƒåŸåˆ™**:
| ç‰¹æ€§ | å†³ç­– |
|------|------|
| âœ… ç±»å‹æ¨æ–­ | å±€éƒ¨å˜é‡æ”¯æŒ |
| âŒ éšå¼è½¬æ¢ | æ— ï¼Œ`Int` â‰  `Float` |
| âŒ any/Unknown | æ—  |
| âŒ å‡½æ•°é‡è½½ | æ—  |
| âœ… Unit | `()` è¡¨ç¤ºæ— è¿”å›å€¼ |
| âŒ Void | ç”¨ Unit æ›¿ä»£ |
| âœ… Never | æ°¸ä¸è¿”å›ç±»å‹ |
| âŒ null | ç”¨ `Option<T>` æ›¿ä»£ |

---

## 6. å­—èŠ‚ç è®¾è®¡

### 6.1 æŒ‡ä»¤é›†

```rust
pub enum OpCode {
    // å¸¸é‡åŠ è½½ (0x00-0x1F)
    LoadConst0 = 0x00, LoadConst1, ..., LoadConst15,
    LoadConst,           // 0x10 + u8
    LoadConstWide,       // 0x11 + u16
    LoadNull = 0x18, LoadTrue, LoadFalse, LoadZero, LoadOne,

    // æ ˆæ“ä½œ (0x20-0x2F)
    Pop = 0x20, Dup, Swap,

    // å±€éƒ¨å˜é‡ (0x30-0x47)
    LoadLocal0 = 0x30, ..., LoadLocal7,
    LoadLocal,           // 0x38 + u8
    StoreLocal0 = 0x40, ..., StoreLocal7,
    StoreLocal,          // 0x48 + u8

    // ç®—æœ¯è¿ç®— (0x60-0x6F)
    Add = 0x60, Sub, Mul, Div, Neg,

    // æ¯”è¾ƒè¿ç®— (0x70-0x77)
    Equal = 0x70, NotEqual, Greater, GreaterEqual, Less, LessEqual,

    // é€»è¾‘è¿ç®— (0x78-0x7B)
    Not = 0x78,

    // æ§åˆ¶æµ (0x80-0x8F)
    Jump = 0x80, JumpIfFalse, JumpBack,

    // å‡½æ•° (0x90-0x9F)
    Call = 0x90, Return, ReturnValue,
    Closure,              // åˆ›å»ºé—­åŒ…/å‡½æ•°å¯¹è±¡
    GetUpvalue,           // è¯»å– upvalueï¼ˆé¢„ç•™ï¼‰
    SetUpvalue,           // è®¾ç½® upvalueï¼ˆé¢„ç•™ï¼‰

    // æ¨¡å— (0xA0-0xAF) - Phase 2.6
    ImportBuiltin = 0xA0, // + u8 æ¨¡å—åç´¢å¼•
    ImportModule,         // + u8 ç”¨æˆ·æ¨¡å—ç´¢å¼•
    GetModuleMember,      // + u8 æˆå‘˜åç´¢å¼•

    // åˆ—è¡¨ (0xB0-0xBF)
    BuildList = 0xB0,     // + u8 å…ƒç´ ä¸ªæ•°
    IndexGet,             // åˆ—è¡¨ç´¢å¼•è¯»å–

    // è°ƒè¯• (0xF0-0xFF)
    Print = 0xF0, Invalid = 0xFF,
}
```

### 6.2 å€¼è¡¨ç¤ºï¼ˆNaN Boxingï¼‰

```
64-bit å¸ƒå±€:
[63] [62-52] [51-48] [47-0]
  â”‚    â”‚       â”‚       â””â”€â”€ Payload (48 bits)
  â”‚    â”‚       â””â”€â”€ Type tag (3 bits)
  â”‚    â””â”€â”€ Exponent (11 bits)
  â””â”€â”€ Sign (1 bit)

ç±»å‹æ ‡ç­¾:
- 000: SMI (å°æ•´æ•°, -2^30 ~ 2^30-1)
- 001: Heap å¯¹è±¡æŒ‡é’ˆ
- 010: Special (null, true, false, Unit)
- 011: Function (å‡½æ•°å¯¹è±¡)
- 100: String (å­—ç¬¦ä¸²å¯¹è±¡)
- 101+: é¢„ç•™ (Result Ok/Err, Option Some/None, Module, NativeFunction ç­‰)
```

### 6.3 è°ƒç”¨çº¦å®š

```
æ ˆå¸§å¸ƒå±€:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â† æ ˆé¡¶
â”‚          æ“ä½œæ•°æ ˆ            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å±€éƒ¨å˜é‡ 0 (slot_base)      â”‚
â”‚  å±€éƒ¨å˜é‡ 1                  â”‚
â”‚  ...                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚      è¿”å›åœ°å€ / åŸ FP         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7. é«˜çº§ç‰¹æ€§è®¾è®¡

### 7.1 é—­åŒ…ï¼ˆPhase 2.3ï¼‰

**æ•è·è¯­ä¹‰**: æŒ‰å¼•ç”¨æ•è·

```rust
struct ObjClosure {
    function: *ObjFunction,
    upvalues: Vec<Gc<ObjUpvalue>>,
}

struct ObjUpvalue {
    location: *mut Value,
    closed: Cell<Value>,
}
```

### 7.2 è¿­ä»£å™¨åè®®ï¼ˆPhase 2.2 W4ï¼‰

**æ ¸å¿ƒè®¾è®¡**:
```rust
// è¿­ä»£å™¨å¯¹è±¡æ¥å£
trait Iterator {
    fn next(&mut self) -> Option<Value>;
}

// åˆ—è¡¨è¿­ä»£å™¨ï¼ˆåŸç”Ÿå®ç°ï¼‰
struct ListIterator {
    list: *ObjList,
    index: usize,
}

impl Iterator for ListIterator {
    fn next(&mut self) -> Option<Value> {
        if self.index < list.len() {
            let value = list[self.index];
            self.index += 1;
            Some(value)
        } else {
            None
        }
    }
}
```

**è¿è¡Œæ—¶æ”¯æŒ**:
- `ObjIterator` - è¿­ä»£å™¨å¯¹è±¡åŸºç±»
- `ListIterator` - åˆ—è¡¨ä¸“ç”¨è¿­ä»£å™¨
- `Option` ç±»å‹ï¼ˆç®€åŒ–ç‰ˆï¼‰ï¼š`Some(value)` / `None`

**for-in ç¼–è¯‘**:
```
for item in iterable { body }
â†“
var $iter = iterable.iter();
while (true) {
    var $next = $iter.next();
    if ($next.is_none()) break;
    var item = $next.unwrap();
    body;
}
```

**ä¸åç¨‹çš„å…³ç³»**:
- å½“å‰è¿­ä»£å™¨ï¼šåŸç”Ÿå¯¹è±¡ï¼ŒçŠ¶æ€æ‰‹åŠ¨ç®¡ç†
- åç¨‹ç”Ÿæˆå™¨ï¼šå¯ç”¨ `yield` å®ç°æƒ°æ€§è¿­ä»£å™¨ï¼ˆPhase 2.4ï¼‰
- åè®®ç»Ÿä¸€ï¼šéƒ½éµå¾ª `iter()` + `next()` æ¥å£

### 7.3 åç¨‹ï¼ˆPhase 2.4ï¼‰

```rust
struct Coroutine {
    stack: Vec<Value>,
    call_stack: Vec<CallFrame>,
    state: CoroState,
}
```

### 7.4 Result ä¸é”™è¯¯å¤„ç†ï¼ˆPhase 2.5ï¼‰

- æ˜¾å¼ Result ç±»å‹
- match è¡¨è¾¾å¼å¤„ç†
- æ—  `?` æ“ä½œç¬¦ï¼ˆå…ˆè·‘é€šåŸºç¡€ï¼‰

---

## 8. ç±»å‹ç³»ç»Ÿè®¾è®¡

### 8.1 è®¾è®¡åŸåˆ™

| ç‰¹æ€§ | å†³ç­– |
|------|------|
| âœ… ç±»å‹æ¨æ–­ | å±€éƒ¨å˜é‡æ”¯æŒ |
| âŒ éšå¼è½¬æ¢ | æ— ï¼Œ`Int` â‰  `Float`ï¼Œå¿…é¡»æ˜¾å¼ `Float(x)` |
| âŒ any/Unknown | æ—  |
| âŒ å‡½æ•°é‡è½½ | æ—  |
| âœ… Unit | `()` è¡¨ç¤ºæ— è¿”å›å€¼ |
| âŒ Void | ç”¨ Unit æ›¿ä»£ |
| âœ… Never | æ°¸ä¸è¿”å›ç±»å‹ |
| âŒ null | ç”¨ `Option<T>` æ›¿ä»£ |

### 8.2 ç±»å‹æ ‡æ³¨è¯­æ³•

```kaubo
// æ˜¾å¼æ ‡æ³¨
var x: Int = 5;

// ç±»å‹æ¨æ–­
var y = 10;  // Int

// å‡½æ•°ç­¾å
fun add(a: Int, b: Int) -> Int {
    return a + b;
}

// Option æ›¿ä»£ null
fun find(nums: List<Int>, target: Int) -> Option<Int> {
    // ...
    return Some(index);
    // æˆ– return None;
}
```

### 8.3 æ— éšå¼è½¬æ¢ç¤ºä¾‹

```kaubo
var i: Int = 5;
var f: Float = i;          // âŒ Error
var f2: Float = Float(i);  // âœ… OK

var sum = i + 3.14;        // âŒ Error
var sum2 = Float(i) + 3.14; // âœ… OK
```

---

## 9. æµ‹è¯•ä¸è´¨é‡

### 9.1 å½“å‰çŠ¶æ€

- **æµ‹è¯•æ•°é‡**: 211 ä¸ª
- **æµ‹è¯•çŠ¶æ€**: å…¨éƒ¨é€šè¿‡ âœ…
- **è¡Œè¦†ç›–ç‡**: 82.11%

### 9.2 è¿è¡Œæµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
cargo test

# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
cargo make cov
```

### 9.3 æµ‹è¯•ç­–ç•¥

- **å•å…ƒæµ‹è¯•**: æ¨¡å—åº•éƒ¨å†…è”æµ‹è¯•
- **é›†æˆæµ‹è¯•**: `tests/integration_tests.rs`

---

## 10. å·²çŸ¥é—®é¢˜

### 10.1 åŠŸèƒ½ç¼ºå¤±ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰

| ä¼˜å…ˆçº§ | é—®é¢˜ | å·¥ä½œé‡ | æ‰€å± Phase |
|--------|------|--------|-----------|
| ğŸ”´ é«˜ | é—­åŒ… Upvalue | 2å‘¨ | 2.3 |
| ğŸŸ¡ ä¸­ | for-in å¾ªç¯ | 1å‘¨ | 2.2 W4 |
| ğŸ”´ é«˜ | é—­åŒ… Upvalue | 2å‘¨ | 2.3 |
| ğŸ”´ é«˜ | åç¨‹å®ç° | 3å‘¨ | 2.4 |
| ğŸŸ¡ ä¸­ | Result ç±»å‹ | 2å‘¨ | 2.5 |
| ğŸŸ¡ ä¸­ | æ ‡è®°-æ¸…é™¤ GC | 2å‘¨ | 2.6 |
| ğŸŸ¢ ä½ | ä¸¥æ ¼ç±»å‹ç³»ç»Ÿ | 2.5å‘¨ | 2.7 |

### 10.2 æŠ€æœ¯å€ºåŠ¡

| é—®é¢˜ | è¯´æ˜ | ä¼˜å…ˆçº§ |
|------|------|--------|
| VM è£¸æŒ‡é’ˆ | ä½¿ç”¨ `*const u8` | ä¸­ |
| å­—ç¬¦ä¸²åˆ†é… | æ¯ä¸ª Token æ–°å»º String | ä½ |
| åŠ¨æ€åˆ†å‘ | `Box<dyn Fn(char) -> bool>` | ä½ |

---

## é™„å½•ï¼šæ—¶é—´çº¿

```
å‘¨æ¬¡    1  2  3  4  5  6  7  8  9  10 11 12 13 14 15 16 17 18 19 20 21
       |--Phase 2.2--|
                      |--Phase 2.3--|
                                     |----Phase 2.4----|
                                                       |--Phase 2.5--|
                                                                      |--2.6--|
                                                                               |--2.7--|

æ€»è®¡: 21 å‘¨ï¼ˆçº¦ 5 ä¸ªæœˆï¼‰
```

---

*æ–‡æ¡£ç‰ˆæœ¬: 1.3*  
*æœ€åæ›´æ–°: 2026-02-09*  
*é¡¹ç›®çŠ¶æ€: Phase 2.2 å®Œæˆï¼ˆå˜é‡ç³»ç»Ÿã€æ§åˆ¶æµã€åˆ—è¡¨ã€for-inï¼‰*
