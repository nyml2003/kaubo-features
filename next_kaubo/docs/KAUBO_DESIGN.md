# Kaubo è®¾è®¡æ–‡æ¡£

> æœ¬æ–‡æ¡£æ˜¯ Kaubo è¯­è¨€çš„å®Œæ•´è®¾è®¡è§„èŒƒï¼ŒåŒ…å«å­—èŠ‚ç ã€ç±»å‹ç³»ç»Ÿã€æ¨¡å—æ¶æ„ç­‰ã€‚

---

## ç›®å½•

1. [å­—èŠ‚ç è®¾è®¡](#1-å­—èŠ‚ç è®¾è®¡)
2. [å€¼è¡¨ç¤ºï¼ˆNaN Boxingï¼‰](#2-å€¼è¡¨ç¤ºnan-boxing)
3. [è®¿é—®ç³»ç»Ÿè®¾è®¡](#3-è®¿é—®ç³»ç»Ÿè®¾è®¡)
4. [æ¨¡å—ç³»ç»Ÿè®¾è®¡](#4-æ¨¡å—ç³»ç»Ÿè®¾è®¡)
5. [æµ‹è¯•è®¡åˆ’](#5-æµ‹è¯•è®¡åˆ’)
6. [é¡¹ç›®çŠ¶æ€](#6-é¡¹ç›®çŠ¶æ€)

---

## 1. å­—èŠ‚ç è®¾è®¡

### 1.1 æŒ‡ä»¤é›†

```rust
pub enum OpCode {
    // ===== å¸¸é‡åŠ è½½ (0x00-0x1F) =====
    LoadConst0 = 0x00, LoadConst1, ..., LoadConst15,
    LoadConst,           // 0x10 + u8 ç´¢å¼•
    LoadConstWide,       // 0x11 + u16 ç´¢å¼•

    LoadNull = 0x18, LoadTrue, LoadFalse, LoadZero, LoadOne,

    // ===== æ ˆæ“ä½œ (0x20-0x2F) =====
    Pop = 0x20, Dup, Swap,

    // ===== å±€éƒ¨å˜é‡ (0x30-0x47) =====
    LoadLocal0 = 0x30, ..., LoadLocal7,
    LoadLocal,           // 0x38 + u8
    StoreLocal0 = 0x40, ..., StoreLocal7,
    StoreLocal,          // 0x48 + u8

    // ===== å…¨å±€å˜é‡ (0x50-0x57) =====
    LoadGlobal = 0x50,   // + u8 æ¨¡å—åç´¢å¼•ï¼ˆæ¨¡å—æ³¨å†Œè¡¨ï¼‰
    StoreGlobal,         // + u8 ç´¢å¼•
    DefineGlobal,        // + u8 ç´¢å¼•

    // ===== ç®—æœ¯è¿ç®— (0x60-0x6F) =====
    Add = 0x60, Sub, Mul, Div,
    Neg = 0x68,

    // ===== æ¯”è¾ƒè¿ç®— (0x70-0x77) =====
    Equal = 0x70, NotEqual, Greater, GreaterEqual, Less, LessEqual,

    // ===== é€»è¾‘è¿ç®— (0x78-0x7B) =====
    Not = 0x78,

    // ===== æ§åˆ¶æµ (0x80-0x8F) =====
    Jump = 0x80, JumpIfFalse, JumpBack,

    // ===== å‡½æ•° (0x90-0x9F) =====
    Call = 0x90, Closure, GetUpvalue, SetUpvalue, CloseUpvalues,
    Return, ReturnValue,

    // ===== åç¨‹ (0x98-0x9F) =====
    CreateCoroutine = 0x98, Resume, Yield, CoroutineStatus,

    // ===== åˆ—è¡¨ (0xB0-0xBF) =====
    BuildList = 0xB0, IndexGet, IndexSet, GetIter, IterNext,

    // ===== JSON (0xC0-0xCF) =====
    BuildJson = 0xC0, JsonGet, JsonSet,

    // ===== æ¨¡å— (0xD0-0xDF) =====
    BuildModule = 0xD0, LoadModule,

    // ===== è°ƒè¯• (0xF0-0xFF) =====
    Print = 0xF0, Invalid = 0xFF,
}
```

### 1.2 è®¿é—®æŒ‡ä»¤è¯­ä¹‰

| æŒ‡ä»¤ | æ“ä½œæ•° | æ ˆå˜åŒ– | è¯´æ˜ |
|------|--------|--------|------|
| `IndexGet` | - | `[obj, idx] â†’ [value]` | æ•´æ•°ç´¢å¼•è®¿é—® List/Module |
| `IndexSet` | - | `[obj, idx, val] â†’ []` | æ•´æ•°ç´¢å¼•èµ‹å€¼ List/Module |
| `JsonGet` | - | `[json, key] â†’ [value]` | å­—ç¬¦ä¸²é”®è®¿é—® JSON |
| `JsonSet` | - | `[json, key, val] â†’ []` | å­—ç¬¦ä¸²é”®èµ‹å€¼ JSON |
| `LoadModule` | u8 | `[] â†’ [module]` | ä»æ¨¡å—æ³¨å†Œè¡¨åŠ è½½æ¨¡å— |

---

## 2. å€¼è¡¨ç¤ºï¼ˆNaN Boxingï¼‰

åŸºäº IEEE 754 double çš„ Quiet NaN ç©ºé—´ï¼Œé‡‡ç”¨ 7-bit Tagã€‚

### 2.1 ä½å¸ƒå±€

```
64-bit å¸ƒå±€:
[63] [62-52] [51] [50-44] [43-0]
  â”‚    â”‚      â”‚     â”‚       â””â”€â”€ Payload (44 bits)
  â”‚    â”‚      â”‚     â””â”€â”€ Tag (7 bits)
  â”‚    â”‚      â””â”€â”€ QNAN æ ‡å¿— (1 bit)
  â”‚    â””â”€â”€ Exponent (11 bits, 0x7FF)
  â””â”€â”€ Sign (1 bit)

å®Œæ•´ä½æ¨¡å¼: 0x7FF8_0000_0000_0000 | (Tag << 44) | Payload
```

### 2.2 ç±»å‹æ ‡ç­¾åˆ†é…

| Tag | ç±»å‹ | è¯´æ˜ |
|-----|------|------|
| 0 | QNAN | è¯­è¨€çº§ NaN |
| 1 | null | ç›´æ¥ä½æ¯”è¾ƒ |
| 2 | true | ç›´æ¥ä½æ¯”è¾ƒ |
| 3 | false | ç›´æ¥ä½æ¯”è¾ƒ |
| 4 | SMI | å°æ•´æ•° (31-bit) |
| 5-7 | é¢„ç•™ | æœªæ¥ç‰¹æ®Šå€¼ |
| 8-23 | InlineInt | å†…è”æ•´æ•° -8~+7 |
| 24-31 | é¢„ç•™ | å†…è”å€¼æ‰©å±• |
| 32 | Heap | é€šç”¨å †å¯¹è±¡ |
| 33 | String | å­—ç¬¦ä¸²å¯¹è±¡ |
| 34 | Function | å‡½æ•°å¯¹è±¡ |
| 35 | List | åˆ—è¡¨å¯¹è±¡ |
| 36 | Iterator | è¿­ä»£å™¨å¯¹è±¡ |
| 37 | Closure | é—­åŒ…å¯¹è±¡ |
| 38 | Coroutine | åç¨‹å¯¹è±¡ |
| 39 | Result | Result å¯¹è±¡ |
| 40 | Option | Option å¯¹è±¡ |
| 41 | JSON | JSON å¯¹è±¡ |
| 42 | Module | æ¨¡å—å¯¹è±¡ |
| 43-127 | é¢„ç•™ | Map/Set/Date/Error ç­‰ |

### 2.3 æ•´æ•°ç¼–ç ç­–ç•¥

```rust
// è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜ç¼–ç 
Value::int(n) åŒ¹é…:
  -8..=7   â†’ InlineInt (Tag ç¼–ç ï¼Œé›¶ç©ºé—´)
  SMI èŒƒå›´ â†’ SMI (31-bit Payload)
  å…¶ä»–     â†’ æº¢å‡ºï¼ˆæœªæ¥ç”¨å † BigIntï¼‰
```

---

## 3. è®¿é—®ç³»ç»Ÿè®¾è®¡

### 3.1 è®¾è®¡åŸåˆ™

- **IndexGet/IndexSet**: ä»…æ•´æ•°ç´¢å¼•ï¼Œä»…æ”¯æŒ Listï¼ˆè¿è¡Œæ—¶åŠ¨æ€ç´¢å¼•ï¼‰
- **ModuleGet**: ShapeID ç´¢å¼•ï¼Œä»…æ”¯æŒ Moduleï¼ˆç¼–è¯‘æœŸç¡®å®šï¼‰
- **JsonGet/JsonSet**: å­—ç¬¦ä¸²é”®ï¼Œä»…æ”¯æŒ JSON å¯¹è±¡
- **æ¨¡å—æ³¨å†Œè¡¨**: æ¨¡å—å­˜å…¥ globals æ³¨å†Œè¡¨ï¼Œä¸æ™®é€šå˜é‡ç»Ÿä¸€å­˜å‚¨

### 3.2 è¯­æ³•æ˜ å°„

| è¯­æ³• | ç±»å‹ | ç¼–è¯‘ç»“æœ |
|------|------|----------|
| `list[0]` | List | `LoadLocal(list) + LoadConst(0) + IndexGet` |
| `list[0] = x` | List | `LoadLocal(list) + LoadConst(0) + LoadLocal(x) + IndexSet` |
| `module.name` | Module | `LoadGlobal(module) + ModuleGet(shape_id)` (shape_idç¼–è¯‘æœŸç¡®å®š) |
| `json["key"]` | JSON | `LoadLocal(json) + LoadConst("key") + JsonGet` |
| `json.key` | JSON | `LoadLocal(json) + LoadConst("key") + JsonGet` (è¯­æ³•ç³–) |
| `json["key"] = x` | JSON | `LoadLocal(json) + LoadConst("key") + LoadLocal(x) + JsonSet` |

**è®¿é—®æ–¹å¼é€‰æ‹©**ï¼š
- **List**: åŠ¨æ€æ•´æ•°ç´¢å¼• â†’ `IndexGet`
- **Module**: ç¼–è¯‘æœŸç¡®å®šå­—æ®µå â†’ `ModuleGet`ï¼ˆé™æ€å¸ƒå±€ï¼ŒO(1)ï¼‰
- **JSON**: åŠ¨æ€å­—ç¬¦ä¸²é”® â†’ `JsonGet`

> **æ³¨æ„**ï¼šæ¨¡å—ä¸æ”¯æŒè¿è¡Œæ—¶åŠ¨æ€ç´¢å¼•ï¼ˆ`math[idx]` éæ³•ï¼‰ï¼Œå› ä¸ºæ¨¡å—æ˜¯é™æ€å¸ƒå±€çš„ã€‚

### 3.3 VM æ¨¡å—å­˜å‚¨

æ¨¡å—ä½œä¸ºæ™®é€šå…¨å±€å˜é‡å­˜å‚¨ï¼Œé€šè¿‡ `LoadGlobal` è®¿é—®ï¼š

```rust
struct VM {
    stack: Vec<Value>,
    frames: Vec<CallFrame>,
    open_upvalues: Vec<*mut ObjUpvalue>,
    globals: HashMap<String, Value>,  // æ¨¡å—å’Œæ™®é€šå˜é‡ç»Ÿä¸€å­˜å‚¨
}
```

**è®¾è®¡ç†ç”±**ï¼š
- ç®€åŒ– VM ç»“æ„ï¼Œæ¨¡å—å°±æ˜¯å€¼ä¸º `ObjModule` çš„å…¨å±€å˜é‡
- ç¼–è¯‘æœŸä¿è¯æ¨¡å—åçš„å”¯ä¸€æ€§
- `LoadModule` æŒ‡ä»¤å®é™…å°±æ˜¯ `LoadGlobal` çš„è¯­ä¹‰

---

## 4. æ¨¡å—ç³»ç»Ÿè®¾è®¡

### 4.1 è®¾è®¡åŸåˆ™

- **æ˜¾å¼å¯¼å‡º**: ä½¿ç”¨ `pub` å…³é”®å­—æ ‡è®°å¯¼å‡ºé¡¹
- **é™æ€å¸ƒå±€**: æ¨¡å—å¯¼å‡ºé¡¹åœ¨ç¼–è¯‘æœŸå®Œå…¨ç¡®å®šï¼Œè¿è¡Œæ—¶å†…å­˜å¸ƒå±€å›ºå®š
- **ShapeID æœºåˆ¶**: æ¯ä¸ªæ¨¡å—å­—æ®µæœ‰ç¼–è¯‘æœŸç¡®å®šçš„ ShapeIDï¼ˆu16ï¼‰ï¼Œè¿è¡Œæ—¶ O(1) è®¿é—®
- **æ³¨å†Œè¡¨æœºåˆ¶**: æ¨¡å—å­˜å…¥ä¸“ç”¨æ³¨å†Œè¡¨ï¼Œä¸æ™®é€šå˜é‡éš”ç¦»

### 4.2 æ¨¡å—å®šä¹‰

```kaubo
module math {
    pub var PI = 3.14159;           // å¯¼å‡ºé¡¹ 0ï¼ŒShapeID=0
    pub var add = |a, b| {          // å¯¼å‡ºé¡¹ 1ï¼ŒShapeID=1
        return a + b;
    };
    var private_var = 100;          // æœªå¯¼å‡ºï¼Œä¸åœ¨ exports ä¸­
}
```

**è¯­æ³•è¯´æ˜**ï¼š
- ä¿ç•™ `pub var` è¯­æ³•ï¼Œä½†è¯­ä¹‰æ”¹ä¸º**é™æ€å­—æ®µå®šä¹‰**
- å¯¼å‡ºé¡¹æŒ‰å®šä¹‰é¡ºåºåˆ†é… ShapeIDï¼ˆä» 0 å¼€å§‹ï¼‰
- æ¨¡å—å†…å¯¼å‡ºé¡¹æ•°é‡ä¸Šé™ï¼š65535ï¼ˆu16ï¼‰

### 4.3 æ¨¡å—è®¿é—®

```kaubo
// å±æ€§è®¿é—®ï¼ˆç¼–è¯‘æœŸç¡®å®š ShapeIDï¼‰
print math.PI;           // LoadGlobal("math") + ModuleGet(0)
print math.add(1, 2);    // LoadGlobal("math") + ModuleGet(1) + Call

// è¿è¡Œæ—¶åŠ¨æ€ç´¢å¼•ï¼ˆä¸æ”¯æŒï¼ï¼‰
// var idx = 0;
// print math[idx];      // ç¼–è¯‘é”™è¯¯ï¼šæ¨¡å—ä¸æ”¯æŒåŠ¨æ€ç´¢å¼•
```

**è®¾è®¡åŸåˆ™**ï¼š
- æ¨¡å—å­—æ®µå¿…é¡»åœ¨ç¼–è¯‘æœŸå®Œå…¨ç¡®å®š
- åªæ”¯æŒ `module.name` å½¢å¼çš„å±æ€§è®¿é—®
- ä¸æ”¯æŒ `module[idx]` å½¢å¼çš„åŠ¨æ€ç´¢å¼•ï¼ˆä¼šç ´åé™æ€å¸ƒå±€ï¼‰

### 4.4 ç¼–è¯‘æµç¨‹

```
1. Parser: module { ... } â†’ ModuleStmt
2. Compiler: 
   - ç¼–è¯‘æ¨¡å—ä½“ï¼Œæ”¶é›† pub æ ‡è®°çš„å¯¼å‡ºé¡¹
   - ä¸ºæ¯ä¸ªå¯¼å‡ºé¡¹åˆ†é… ShapeIDï¼ˆæŒ‰å®šä¹‰é¡ºåºï¼Œu16ï¼‰
   - ç”Ÿæˆ BuildModule æŒ‡ä»¤åˆ›å»ºæ¨¡å—å¯¹è±¡
3. VM: 
   - BuildModule åˆ›å»º ObjModuleï¼ˆå›ºå®šé•¿åº¦ exportsï¼‰
   - å­˜å…¥ globals æ³¨å†Œè¡¨
```

### 4.5 è¿è¡Œæ—¶æ¨¡å—å¯¹è±¡

```rust
pub struct ObjModule {
    pub name: String,
    pub exports: Box<[Value]>,                  // å›ºå®šé•¿åº¦æ•°ç»„ï¼ŒæŒ‰ ShapeID ç´¢å¼•
    pub name_to_index: HashMap<String, u16>,   // åç§°åˆ° ShapeID æ˜ å°„ï¼ˆç¼–è¯‘æœŸ/è°ƒè¯•ç”¨ï¼‰
}

impl ObjModule {
    /// é€šè¿‡ ShapeID è·å–å¯¼å‡ºé¡¹ï¼ˆO(1)ï¼‰
    pub fn get_by_shape_id(&self, shape_id: u16) -> Option<Value> {
        self.exports.get(shape_id as usize).copied()
    }
}
```

### 4.6 æ¨¡å—è®¿é—®æŒ‡ä»¤

| æŒ‡ä»¤ | æ“ä½œæ•° | æ ˆå˜åŒ– | è¯´æ˜ |
|------|--------|--------|------|
| `LoadModule` | u8 | `[] â†’ [module]` | ä»å…¨å±€å˜é‡åŠ è½½æ¨¡å— |
| `ModuleGet` | u16 | `[module] â†’ [value]` | é€šè¿‡ ShapeID è·å–å­—æ®µ |

**å­—èŠ‚ç ç¤ºä¾‹**ï¼š
```
math.PI
  LoadGlobal "math"     // åŠ è½½æ¨¡å—å¯¹è±¡
  ModuleGet 0           // è·å– ShapeID=0 çš„å­—æ®µ (PI)

math.add(1, 2)
  LoadGlobal "math"     // åŠ è½½æ¨¡å—å¯¹è±¡
  ModuleGet 1           // è·å– ShapeID=1 çš„å­—æ®µ (add)
  LoadConst 1           // å‚æ•° 1
  LoadConst 2           // å‚æ•° 2
  Call 2                // è°ƒç”¨
```

### 4.7 æ¨¡å—å¯å˜æ€§

**Phase 1 é™åˆ¶**ï¼šæ¨¡å—å¯¼å‡ºé¡¹**åªè¯»**ï¼Œæš‚ä¸æ”¯æŒ `ModuleSet`ã€‚

```kaubo
module math { pub PI = 3.14; }
math.PI = 3.14159;  // è¿è¡Œæ—¶é”™è¯¯ï¼šæ¨¡å—å­—æ®µåªè¯»
```

æœªæ¥å¦‚éœ€å¯å˜æ€§ï¼Œå°†æ·»åŠ  `ModuleSet` æŒ‡ä»¤ã€‚

### 4.8 ç»“æ„ä½“ç³»ç»Ÿï¼ˆPhase 3ï¼‰

**è®¾è®¡åŸåˆ™**ï¼š
- ç»“æ„ä½“**åªæè¿°å†…å­˜å¸ƒå±€**ï¼ˆçº¯æ•°æ®ï¼‰
- æ–¹æ³•å¿…é¡»é€šè¿‡ **Interface** å®šä¹‰
- é€šè¿‡ **impl** è¯­æ³•ä¸ºç»“æ„ä½“å®ç° Interface
- ç±»ä¼¼ Goï¼ˆstruct + interfaceï¼‰å’Œ Rustï¼ˆstruct + traitï¼‰çš„æ··åˆ

#### 4.8.1 ç»“æ„ä½“å®šä¹‰

```kaubo
// ç»“æ„ä½“ï¼šçº¯æ•°æ®å¸ƒå±€ï¼ŒShapeID ç³»ç»Ÿå¤ç”¨æ¨¡å—çš„é™æ€å¸ƒå±€æœºåˆ¶
struct Point {
    x: float,
    y: float,
}

struct Rect {
    origin: Point,
    width: float,
    height: float,
}
```

**ç‰¹æ€§**ï¼š
- å­—æ®µå¿…é¡»æ˜¾å¼å£°æ˜ç±»å‹ï¼ˆæœªæ¥æ”¯æŒç±»å‹æ¨æ–­ï¼‰
- ç¼–è¯‘æœŸç¡®å®š Shapeï¼Œè¿è¡Œæ—¶ O(1) å­—æ®µè®¿é—®
- ç»“æ„ä½“æœ¬èº«æ— æ–¹æ³•

#### 4.8.2 Interface å®šä¹‰

```kaubo
// Interfaceï¼šæ–¹æ³•å¥‘çº¦é›†åˆ
interface Shape {
    area() -> float;
    perimeter() -> float;
}

interface Drawable {
    draw(canvas: Canvas);
    move(dx: float, dy: float);
}
```

**ç‰¹æ€§**ï¼š
- Interface åªå®šä¹‰æ–¹æ³•ç­¾åï¼Œæ— é»˜è®¤å®ç°ï¼ˆåˆæœŸï¼‰
- éšå¼å®ç°ï¼šç»“æ„ä½“å®ç° Interface çš„æ‰€æœ‰æ–¹æ³•å³è‡ªåŠ¨æ»¡è¶³è¯¥ Interface
- æ”¯æŒ Interface ç»„åˆ

#### 4.8.3 å®ç°è¯­æ³•

```kaubo
// ä¸º Point å®ç°æ–¹æ³•ï¼ˆç±»ä¼¼ Go çš„æ¥æ”¶è€…è¯­æ³•ï¼‰
impl Point {
    // æ„é€ å‡½æ•°ï¼ˆçº¦å®šä¿—æˆï¼‰
    new(x: float, y: float) -> Point {
        return Point { x: x, y: y };
    }
    
    // æ–¹æ³•ï¼ˆç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ selfï¼‰
    distance(other: Point) -> float {
        var dx = self.x - other.x;
        var dy = self.y - other.y;
        return math.sqrt(dx * dx + dy * dy);
    }
}

// ä¸º Rect å®ç° Shape Interface
impl Shape for Rect {
    area() -> float {
        return self.width * self.height;
    }
    
    perimeter() -> float {
        return 2 * (self.width + self.height);
    }
}

// ä¸º Rect å®ç° Drawable Interface
impl Drawable for Rect {
    draw(canvas: Canvas) {
        // ...
    }
    
    move(dx: float, dy: float) {
        self.origin.x = self.origin.x + dx;
        self.origin.y = self.origin.y + dy;
    }
}
```

#### 4.8.4 å†…å­˜å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç»“æ„ä½“å†…å­˜å¸ƒå±€                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ObjectHeader â”‚ ShapeID â”‚ Field1 â”‚ Field2 â”‚ ...                  â”‚
â”‚   (16 bytes)  â”‚ (u16)   â”‚        â”‚        â”‚                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Shape è¡¨ï¼ˆå…¨å±€ï¼‰ â”‚
        â”‚  - ç»“æ„ä½“åç§°    â”‚
        â”‚  - å­—æ®µæ•°é‡      â”‚
        â”‚  - æ¯ä¸ªå­—æ®µåç§»  â”‚
        â”‚  - å®ç°çš„ Interfaces â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¸æ¨¡å—çš„å…³ç³»**ï¼š
- æ¨¡å—æ˜¯ç¼–è¯‘æœŸå•ä¾‹ï¼Œç»“æ„ä½“æ˜¯è¿è¡Œæ—¶å¤šå®ä¾‹
- å…±äº« Shape ç³»ç»Ÿçš„åŸºç¡€è®¾æ–½
- æ¨¡å—çš„å­—æ®µè®¿é—®å’Œç»“æ„ä½“çš„å­—æ®µè®¿é—®ä½¿ç”¨ç›¸åŒçš„åº•å±‚æœºåˆ¶

### 4.9 æœªæ¥ï¼šæ ‡å‡†åº“æ³¨å†Œè¡¨

```rust
// å†…ç½®æ¨¡å—æ³¨å†Œ
lazy_static! {
    static ref BUILTIN_MODULES: HashMap<&'static str, BuiltinModule> = {
        let mut m = HashMap::new();
        m.insert("std.core", create_core_module());
        m.insert("std.math", create_math_module());
        m
    };
}

// std.core æ¨¡å—
fn create_core_module() -> BuiltinModule {
    let mut fields = HashMap::new();
    fields.insert("print".to_string(), Value::native_fn(print_fn));
    fields.insert("assert".to_string(), Value::native_fn(assert_fn));
    BuiltinModule::new(fields)
}
```

---

## 5. æµ‹è¯•è®¡åˆ’

### 5.1 å½“å‰æµ‹è¯•ç»Ÿè®¡

- **å•å…ƒæµ‹è¯•**: 227 ä¸ª
- **é›†æˆæµ‹è¯•æ–‡ä»¶**: 21 ä¸ª
- **ä»£ç è¦†ç›–ç‡**: çº¦ 65%

### 5.2 æµ‹è¯•ç¼ºå£

| ç±»åˆ« | ç¼ºå£ | ä¼˜å…ˆçº§ |
|------|------|--------|
| è¾¹ç•Œæ¡ä»¶ | åˆ—è¡¨è¶Šç•Œã€ç©ºåˆ—è¡¨ã€é™¤é›¶ | é«˜ |
| JSON æµ‹è¯• | åµŒå¥—æ·±åº¦ã€ç‰¹æ®Šé”®å | é«˜ |
| åç¨‹æµ‹è¯• | å¼‚å¸¸å¤„ç†ã€åµŒå¥—åç¨‹ | ä¸­ |
| é—­åŒ…æµ‹è¯• | å¤šå±‚åµŒå¥—ã€å¾ªç¯å¼•ç”¨ | ä¸­ |
| æ€§èƒ½æµ‹è¯• | å¤§åˆ—è¡¨ã€æ·±é€’å½’ | ä½ |

### 5.3 æµ‹è¯•æ–‡ä»¶è§„åˆ’

```
tests/
â”œâ”€â”€ boundary_tests.rs      # è¾¹ç•Œæ¡ä»¶æµ‹è¯•
â”œâ”€â”€ json_tests.rs          # JSON åŠŸèƒ½æµ‹è¯•
â”œâ”€â”€ coroutine_tests.rs     # åç¨‹æµ‹è¯•
â”œâ”€â”€ closure_tests.rs       # é—­åŒ…æµ‹è¯•
â”œâ”€â”€ module_tests.rs        # æ¨¡å—ç³»ç»Ÿæµ‹è¯•
â””â”€â”€ benchmarks/            # æ€§èƒ½åŸºå‡†æµ‹è¯•
```

### 5.4 ç›®æ ‡æŒ‡æ ‡

| æŒ‡æ ‡ | å½“å‰ | ç›®æ ‡ |
|------|------|------|
| å•å…ƒæµ‹è¯•æ•° | 227 | 350+ |
| ä»£ç è¦†ç›–ç‡ | ~65% | 85%+ |
| é›†æˆæµ‹è¯•æ–‡ä»¶ | 21 | 40+ |
| å¹³å‡æµ‹è¯•æ—¶é—´ | 12s | <5s |

---

## 6. é¡¹ç›®çŠ¶æ€ä¸è·¯çº¿å›¾

### 6.1 å¼€å‘é˜¶æ®µæ€»è§ˆ

```
Phase 2.x (å½“å‰) â”€â”€â–º Phase 3.0 â”€â”€â–º Phase 4.0 â”€â”€â–º Phase 5.0
åŸºç¡€è¯­è¨€åŠŸèƒ½       Shapeç³»ç»Ÿ      ç±»å‹ç³»ç»Ÿ       å·¥ç¨‹åŒ–
```

### 6.2 å·²å®ç°åŠŸèƒ½ âœ…

| ç‰¹æ€§ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| å˜é‡å£°æ˜ | âœ… | `var x = 5;` |
| åŸºæœ¬ç±»å‹ | âœ… | int, float, bool, null, string |
| ç®—æœ¯/æ¯”è¾ƒ/é€»è¾‘ | âœ… | å®Œæ•´è¿ç®—ç¬¦æ”¯æŒ |
| æ¡ä»¶/å¾ªç¯ | âœ… | if/elif/else, while, for-in |
| åˆ—è¡¨ | âœ… | `[1, 2, 3]`, ç´¢å¼•è®¿é—®/èµ‹å€¼ |
| Lambda/é—­åŒ… | âœ… | è‡ªåŠ¨ upvalue ç®¡ç† |
| åç¨‹ | âœ… | create_coroutine, yield, resume |
| JSON | âœ… | å­—é¢é‡ã€æˆå‘˜è®¿é—®ã€èµ‹å€¼ |
| æ¨¡å—å®šä¹‰ | âœ… | `module { ... }`, `pub` |

### 6.3 è¿›è¡Œä¸­ ğŸš§

| ç‰¹æ€§ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| æ¨¡å—é™æ€åŒ– | ğŸš§ | ShapeID ç³»ç»Ÿï¼ŒO(1) å­—æ®µè®¿é—® |
| æµ®ç‚¹æ•°è§£æä¿®å¤ | ğŸš§ | å°æ•°è§£æé—®é¢˜ |

### 6.4 å®Œæ•´ç‰¹æ€§ä¼˜å…ˆçº§çŸ©é˜µ

| ç‰¹æ€§ | é˜¶æ®µ | éš¾åº¦ | ä»·å€¼ | ä¾èµ– | ä¼˜å…ˆçº§ |
|------|------|------|------|------|--------|
| **æ¨¡å—é™æ€åŒ–** | 2.7 | â­â­â­ | â­â­â­ | - | ğŸ”¥ P0 |
| **æµ®ç‚¹æ•°ä¿®å¤** | 2.7 | â­ | â­â­ | - | ğŸ”¥ P0 |
| **break/continue** | 2.8 | â­ | â­â­â­ | - | â­ P1 |
| **è¾¹ç•Œæµ‹è¯•** | 2.8 | â­â­ | â­â­â­ | - | â­ P1 |
| **æ ‡å‡†åº“ (std.core)** | 2.9 | â­â­ | â­â­â­ | æ¨¡å—é™æ€åŒ– | â­ P1 |
| **ç»“æ„ä½“ (struct)** | 3.0 | â­â­â­ | â­â­â­ | æ¨¡å—é™æ€åŒ– | â­ P1 |
| **Interface ç³»ç»Ÿ** | 3.1 | â­â­â­ | â­â­â­ | ç»“æ„ä½“ | â­ P1 |
| **impl å®ç°è¯­æ³•** | 3.2 | â­â­â­â­ | â­â­â­ | Interface | ğŸŒ™ P2 |
| **Result/Option æ–¹æ³•** | 3.2 | â­â­ | â­â­ | - | ğŸŒ™ P2 |
| **typeof è¿ç®—ç¬¦** | 3.2 | â­ | â­ | - | ğŸŒ™ P2 |
| **å­—ç¬¦ä¸²æ’å€¼** | 3.3 | â­â­ | â­â­ | - | ğŸŒ™ P2 |
| **match è¡¨è¾¾å¼** | 3.4 | â­â­â­ | â­â­â­ | - | ğŸŒ™ P3 |
| **æ³›å‹** | 4.0 | â­â­â­â­â­ | â­â­â­ | ç±»å‹ç³»ç»Ÿ | ğŸŒ™ P3 |
| **é”™è¯¯ä¼ æ’­ `?`** | 4.0 | â­â­â­ | â­â­ | Result | ğŸŒ™ P3 |
| **åŒ…ç®¡ç†å™¨** | 5.0 | â­â­â­â­ | â­â­â­ | - | ğŸŒ™ P3 |

### 6.5 é˜¶æ®µè¯¦ç»†è§„åˆ’

#### Phase 2.xï¼šåŸºç¡€å®Œå–„ï¼ˆå½“å‰ - 2æœˆåº•ï¼‰

**ç›®æ ‡**ï¼šè¯­è¨€åŸºç¡€åŠŸèƒ½ç¨³å®šï¼Œæ¨¡å—ç³»ç»Ÿå¯ç”¨

| ç‰ˆæœ¬ | ç‰¹æ€§ | äº¤ä»˜æ ‡å‡† |
|------|------|----------|
| 2.7 | æ¨¡å—é™æ€åŒ– + æµ®ç‚¹æ•°ä¿®å¤ | `math.PI` ç¼–è¯‘æœŸ O(1) è®¿é—®ï¼Œå°æ•°è§£ææ­£ç¡® |
| 2.8 | break/continue + è¾¹ç•Œæµ‹è¯• | å¾ªç¯æ§åˆ¶å®Œå–„ï¼Œæµ‹è¯•è¦†ç›–ç‡ 85%+ |
| 2.9 | æ ‡å‡†åº“åŸºç¡€ | `std.core` (print, assert, type), `std.math` (sqrt, sin, cos) |

#### Phase 3.0ï¼šShape ç³»ç»Ÿï¼ˆ3æœˆ - 4æœˆï¼‰

**ç›®æ ‡**ï¼šé™æ€å¸ƒå±€åŸºç¡€è®¾æ–½ï¼Œæ”¯æŒç»“æ„ä½“

| ç‰ˆæœ¬ | ç‰¹æ€§ | è¯´æ˜ |
|------|------|------|
| 3.0 | ç»“æ„ä½“åŸºç¡€ | `struct Point { x: float, y: float }`, å®ä¾‹åˆ›å»ºï¼Œå­—æ®µè®¿é—® |
| 3.1 | Interface ç³»ç»Ÿ | `interface Shape { area() -> float; }` |
| 3.2 | impl è¯­æ³• + æ–¹æ³•è°ƒç”¨ | `impl Point { distance(other) -> float { ... } }` |
| 3.3 | è¯­æ³•ç³– | å­—ç¬¦ä¸²æ’å€¼ã€typeofã€Result/Option æ–¹æ³• |
| 3.4 | match è¡¨è¾¾å¼ | æ¨¡å¼åŒ¹é…åŸºç¡€ |

#### Phase 4.0ï¼šç±»å‹ç³»ç»Ÿï¼ˆ5æœˆ - 6æœˆï¼‰

**ç›®æ ‡**ï¼šé™æ€ç±»å‹æ£€æŸ¥ï¼Œæ³›å‹æ”¯æŒ

| ç‰ˆæœ¬ | ç‰¹æ€§ | è¯´æ˜ |
|------|------|------|
| 4.0 | å¯é€‰ç±»å‹æ ‡æ³¨ | `var x: int = 5;` |
| 4.1 | æ³›å‹ç»“æ„ä½“ | `struct Box<T> { value: T }` |
| 4.2 | æ³›å‹ Interface | `interface Container<T> { get() -> T; }` |
| 4.3 | é”™è¯¯ä¼ æ’­ `?` | `var x = may_fail()?;` |

#### Phase 5.0ï¼šå·¥ç¨‹åŒ–ï¼ˆ7æœˆä»¥åï¼‰

**ç›®æ ‡**ï¼šç”Ÿäº§å¯ç”¨ï¼Œç”Ÿæ€å»ºè®¾

| ç‰ˆæœ¬ | ç‰¹æ€§ | è¯´æ˜ |
|------|------|------|
| 5.0 | åŒ…ç®¡ç†å™¨ | `kaubo add some_pkg` |
| 5.1 | LSP æ”¯æŒ | IDE è‡ªåŠ¨è¡¥å…¨ã€è·³è½¬ |
| 5.2 | ç¼–è¯‘ä¼˜åŒ– | AOT ç¼–è¯‘ã€ä»£ç ä¼˜åŒ– |

### 6.4 æŠ€æœ¯å€ºåŠ¡

- ç¼–è¯‘å™¨è­¦å‘Šï¼ˆçº¦ 40+ ä¸ªæœªä½¿ç”¨ä»£ç ï¼‰
- Parser/Compiler æ–‡ä»¶è¿‡å¤§ï¼Œéœ€æ‹†åˆ†
- å­—ç¬¦ä¸²å¤åˆ¶ä¼˜åŒ–ï¼ˆä½¿ç”¨ Rc/Arcï¼‰

---

*æ–‡æ¡£ç‰ˆæœ¬: 2.0*  
*æœ€åæ›´æ–°: 2026-02-10*
