# Kaubo ç¼–è¯‘å™¨ - é¡¹ç›®æ–‡æ¡£

## 1. é¡¹ç›®æ¦‚è¿°

**Kaubo** æ˜¯ä¸€ä¸ªç°ä»£ç¼–ç¨‹è¯­è¨€çš„ç¼–è¯‘å™¨å‰ç«¯å®ç°ï¼Œé‡‡ç”¨ Rust ç¼–å†™ï¼ŒåŒ…å«å®Œæ•´çš„è¯æ³•åˆ†æå™¨å’Œè¯­æ³•åˆ†æå™¨ã€‚

| å±æ€§ | å€¼ |
|------|-----|
| åç§° | next_kaubo |
| ç‰ˆæœ¬ | 0.1.0 |
| è¯­è¨€ | Rust (Edition 2024) |
| æ¶æ„ | çŠ¶æ€æœºé©±åŠ¨çš„ Lexer + Pratt Parser |

### 1.1 é¡¹ç›®ç»“æ„

```
src/
â”œâ”€â”€ main.rs                 # ç¨‹åºå…¥å£
â”œâ”€â”€ compiler/               # ç¼–è¯‘å™¨æ¨¡å—
â”‚   â”œâ”€â”€ lexer/              # Kaubo è¯­è¨€ä¸“ç”¨è¯æ³•åˆ†æå™¨
â”‚   â”‚   â”œâ”€â”€ builder.rs      # Lexer æ„å»ºå™¨
â”‚   â”‚   â””â”€â”€ token_kind.rs   # Token ç±»å‹å®šä¹‰
â”‚   â”œâ”€â”€ parser/             # è¯­æ³•åˆ†æå™¨
â”‚   â”‚   â”œâ”€â”€ parser.rs       # Pratt è§£æå™¨å®ç°
â”‚   â”‚   â”œâ”€â”€ expr.rs         # è¡¨è¾¾å¼ AST
â”‚   â”‚   â”œâ”€â”€ stmt.rs         # è¯­å¥ AST
â”‚   â”‚   â”œâ”€â”€ module.rs       # æ¨¡å— AST
â”‚   â”‚   â”œâ”€â”€ error.rs        # é”™è¯¯ç±»å‹
â”‚   â”‚   â””â”€â”€ utils.rs        # å·¥å…·å‡½æ•°
â”‚   â””â”€â”€ ir/                 # ä¸­é—´è¡¨ç¤ºï¼ˆé¢„ç•™ï¼‰
â””â”€â”€ kit/                    # é€šç”¨å·¥å…·åŒ…
    â”œâ”€â”€ lexer/              # å¯å¤ç”¨çš„è¯æ³•åˆ†ææ¡†æ¶
    â”‚   â”œâ”€â”€ c_lexer.rs      # é€šç”¨ Lexer å®ç°
    â”‚   â”œâ”€â”€ types.rs        # Token/Coordinate ç±»å‹
    â”‚   â””â”€â”€ state_machine/  # çŠ¶æ€æœºæ¡†æ¶
    â””â”€â”€ ring_buffer/        # ç¯å½¢ç¼“å†²åŒº
```

---

## 2. æŠ€æœ¯æ¶æ„

### 2.1 è¯æ³•åˆ†æå™¨

é‡‡ç”¨**çŠ¶æ€æœºé©±åŠ¨**æ¶æ„ï¼Œæ”¯æŒæµå¼è¾“å…¥å’Œ UTF-8ã€‚

**æ ¸å¿ƒæµç¨‹**:
```
è¾“å…¥å­—èŠ‚æµ â†’ ç¯å½¢ç¼“å†²åŒº â†’ UTF-8è§£ç  â†’ çŠ¶æ€æœºç«äº‰åŒ¹é… â†’ Tokenè¾“å‡º
```

**æ”¯æŒçš„ Token ç±»å‹**:

| ç±»åˆ« | Token |
|------|-------|
| å…³é”®å­— | `var`, `if`, `else`, `elif`, `while`, `for`, `return`, `true`, `false`, `null`, `and`, `or`, `not`, `async`, `await` ç­‰ 26 ä¸ª |
| å­—é¢é‡ | `LiteralInteger`, `LiteralString` |
| è¿ç®—ç¬¦ | `==`, `!=`, `>=`, `<=`, `>`, `<`, `+`, `-`, `*`, `/`, `=`, `.`, `\|` ç­‰ |
| åˆ†éš”ç¬¦ | `(`, `)`, `{`, `}`, `[`, `]`, `,`, `;`, `:` |

### 2.2 è¯­æ³•åˆ†æå™¨

é‡‡ç”¨ **Pratt è§£æç®—æ³•**ï¼ˆTop-down operator precedenceï¼‰ã€‚

**ä¼˜å…ˆçº§è¡¨**ï¼ˆä»é«˜åˆ°ä½ï¼‰:

| ä¼˜å…ˆçº§ | è¿ç®—ç¬¦ | è¯´æ˜ |
|--------|--------|------|
| 450 | `not` | ä¸€å…ƒé€»è¾‘é |
| 400 | `.` | æˆå‘˜è®¿é—® |
| 300 | `*`, `/` | ä¹˜é™¤ |
| 200 | `+`, `-` | åŠ å‡ |
| 100 | `==`, `!=`, `>`, `<`, `>=`, `<=` | æ¯”è¾ƒ |
| 80 | `and` | é€»è¾‘ä¸ |
| 70 | `\|` | ç®¡é“ |
| 60 | `or` | é€»è¾‘æˆ– |
| 50 | `=` | èµ‹å€¼ |

**AST ç»“æ„**:

```rust
// è¡¨è¾¾å¼
pub enum ExprKind {
    LiteralInt(LiteralInt),       // 42
    LiteralString(LiteralString), // "hello"
    LiteralTrue, LiteralFalse, LiteralNull,
    LiteralList(LiteralList),     // [1, 2, 3]
    Binary(Binary),               // a + b
    Unary(Unary),                 // -a, not b
    Grouping(Grouping),           // (a + b)
    VarRef(VarRef),               // x
    FunctionCall(FunctionCall),   // foo(a, b)
    Assign(Assign),               // x = 5
    Lambda(Lambda),               // |x| { x + 1 }
    MemberAccess(MemberAccess),   // obj.field
}

// è¯­å¥
pub enum StmtKind {
    Expr(ExprStmt),               // a + b;
    Empty,                        // ;
    Block(BlockStmt),             // { ... }
    VarDecl(VarDeclStmt),         // var x = 5;
    If(IfStmt),                   // if/elif/else
    While(WhileStmt),             // while (cond) { ... }
    For(ForStmt),                 // for (i) in (list) { ... }
    Return(ReturnStmt),           // return value;
}
```

---

## 3. æ”¯æŒçš„è¯­è¨€ç‰¹æ€§

### 3.1 å½“å‰æ”¯æŒ

```kaubo
// å˜é‡å£°æ˜
var x = 5;
var s = "hello";
var flag = true;

// ç®—æœ¯è¡¨è¾¾å¼
var a = 1 + 2 * 3;
var b = (10 - 5) / 2;

// æ¯”è¾ƒå’Œé€»è¾‘
var c = a > b and b < 10;
var d = not c;

// æ¡ä»¶è¯­å¥
if (a > b) {
    print("a is bigger");
} elif (a == b) {
    print("equal");
} else {
    print("b is bigger");
}

// å¾ªç¯
while (i < 10) {
    i = i + 1;
}

for (item) in (list) {
    print(item);
}

// åˆ—è¡¨
var nums = [1, 2, 3];

// å‡½æ•°ï¼ˆLambdaï¼‰
var add = |x, y| {
    return x + y;
};

// æˆå‘˜è®¿é—®
var len = list.length();
```

### 3.2 å·²çŸ¥é™åˆ¶

| é™åˆ¶ | è¯´æ˜ | çŠ¶æ€ |
|------|------|------|
| å­—ç¬¦ä¸²æ— è½¬ä¹‰ | `"hello\n"` ä¸­çš„ `\n` ä¸ä¼šè½¬ä¹‰ | å¾…ä¿®å¤ |
| èµ‹å€¼å—é™ | åªæ”¯æŒ `x = 5`ï¼Œä¸æ”¯æŒ `obj.x = 5` | å¾…ä¿®å¤ |
| æ— ç´¢å¼•è®¿é—® | ä¸æ”¯æŒ `arr[0]` | å¾…ä¿®å¤ |
| æ— æµ®ç‚¹æ•° | åªæ”¯æŒæ•´æ•° | å¾…æ·»åŠ  |

---

## 4. æµ‹è¯•ç­–ç•¥

é‡‡ç”¨**æ··åˆæµ‹è¯•æ–¹æ¡ˆ**ï¼šå†…è”å•å…ƒæµ‹è¯• + é›†æˆæµ‹è¯•åˆ†ç¦»ã€‚

### 4.1 å†…è”å•å…ƒæµ‹è¯•ï¼ˆä¸»è¦ï¼‰

ä½äº `src/` å„æ¨¡å—åº•éƒ¨ï¼Œæµ‹è¯•ç§æœ‰å‡½æ•°å’Œå†…éƒ¨é€»è¾‘ã€‚

```rust
// src/compiler/lexer/builder.rs
#[cfg(test)]
mod tests {
    use super::*;
    
    #[test]
    fn test_keyword_machine() {
        // ç›´æ¥æµ‹è¯•å†…éƒ¨å‡½æ•°
    }
}
```

**é€‚ç”¨åœºæ™¯**:
- çŠ¶æ€æœºçš„å†…éƒ¨è½¬æ¢é€»è¾‘
- Pratt è§£æå™¨çš„ä¼˜å…ˆçº§è®¡ç®—
- è¾¹ç•Œæƒ…å†µï¼ˆç©ºè¾“å…¥ã€è¶…é•¿ token ç­‰ï¼‰
- éœ€è¦è®¿é—®ç§æœ‰å‡½æ•°çš„å·¥å…·æ–¹æ³•

### 4.2 é›†æˆæµ‹è¯•ï¼ˆè¾…åŠ©ï¼‰

ä½äº `tests/` ç›®å½•ï¼Œæµ‹è¯•å…¬å…± API å’Œç«¯åˆ°ç«¯åœºæ™¯ã€‚

```rust
// tests/integration_tests.rs
#[test]
fn test_parse_hello_world() {
    let code = r#"var x = "hello";"#;
    let ast = parse(code).unwrap();
    // éªŒè¯ AST ç»“æ„
}
```

**é€‚ç”¨åœºæ™¯**:
- å®Œæ•´æ–‡ä»¶è§£æ
- ç«¯åˆ°ç«¯ç¼–è¯‘æµç¨‹
- ç¤ºä¾‹ç¨‹åºéªŒè¯

### 4.3 æµ‹è¯•ç›®å½•ç»“æ„

```
tests/
â”œâ”€â”€ integration_tests.rs      # ä¸»è¦é›†æˆæµ‹è¯•
â””â”€â”€ fixtures/                 # æµ‹è¯•ä»£ç æ–‡ä»¶
    â”œâ”€â”€ basic.kaubo
    â”œâ”€â”€ expressions.kaubo
    â””â”€â”€ statements.kaubo
```

**å†³ç­–ç†ç”±**:
- Lexer/Parser å†…éƒ¨é€»è¾‘å¤æ‚ï¼Œéœ€è¦æµ‹è¯•ç§æœ‰å‡½æ•°
- å†…è”æµ‹è¯•æ–¹ä¾¿ä¿®æ”¹æ—¶åŒæ­¥æ›´æ–°
- é›†æˆæµ‹è¯•éªŒè¯æ•´ä½“åŠŸèƒ½æ­£ç¡®æ€§
- ç¬¦åˆ Rust ç¤¾åŒºæƒ¯ä¾‹

---

## 5. å¼€å‘è·¯çº¿å›¾

### Phase 1: æµ‹è¯•ä¸ä¿®å¤ (å½“å‰ - è¿›è¡Œä¸­)

**ç›®æ ‡**: å»ºç«‹å®Œæ•´æµ‹è¯•å¥—ä»¶ï¼Œä¿®å¤æ‰€æœ‰å·²çŸ¥ Bugï¼Œç¡®ä¿å‰ç«¯ç¨³å®šå¯é ã€‚

**æœ¬å‘¨ä»»åŠ¡æ¸…å•** (Phase 1 å·²å®Œæˆ):
```markdown
- [x] åˆ›å»º tests/ ç›®å½•ç»“æ„
- [x] è¡¥å…¨ Lexer æµ‹è¯•ï¼ˆæ‰€æœ‰ Token ç±»å‹è¯†åˆ«ï¼‰
- [x] è¡¥å…¨ Parser æµ‹è¯•ï¼ˆè¡¨è¾¾å¼ã€è¯­å¥ã€è¾¹ç•Œæƒ…å†µï¼‰
- [x] ä¿®å¤ parser.rs:336 æ— æ•ˆ check è°ƒç”¨
- [x] ä¿®å¤ get_associativity ç¡¬ç¼–ç è¿”å› true
- [x] ä¿®å¤ whitespace_machine é”™è¯¯åŒ¹é…æ¢è¡Œ
```

**Phase 1 å®Œæˆæ ‡å‡†**:
- [x] æµ‹è¯•è¦†ç›–ç‡ (è¡Œè¦†ç›–) > 80% â†’ **90.18%** âœ…
- [x] åˆ†æ”¯è¦†ç›–ç‡ â†’ **83.98%** âœ… (ä½¿ç”¨ cargo-llvm-cov + nightly)
- [x] `cargo test` å…¨ç»¿ â†’ **105 ä¸ªæµ‹è¯•é€šè¿‡** âœ…
- [x] æ— ä¸¥é‡ç¼–è¯‘å™¨è­¦å‘Š âš ï¸ (ä»…æœªä½¿ç”¨ä»£ç è­¦å‘Šï¼Œå±é¢„æœŸå†…)
- [ ] CI é€šè¿‡ â¬œ (å¾…æ·»åŠ  GitHub Actions)

**Phase 1 æˆæœ**:
- å‰ç«¯ Lexer/Parser ç¨³å®šå¯é 
- æµ‹è¯•è¦†ç›–å…¨é¢
- å·²çŸ¥ Bug å·²ä¿®å¤ ([è¯¦è§ ISSUES.md](ISSUES.md))

**Phase 2 å¯åŠ¨æ¡ä»¶**: âœ… å·²æ»¡è¶³ (è¦†ç›–ç‡è¾¾æ ‡ + æµ‹è¯•å…¨ç»¿)

### Phase 2: å­—èŠ‚ç åç«¯ ğŸš§ (è¿›è¡Œä¸­ - Phase 2.1 å·²å®Œæˆ)

**æ–¹å‘**: åŸºäºæ ˆçš„å­—èŠ‚ç è™šæ‹Ÿæœºï¼ˆStack-based VMï¼‰ï¼Œè€Œé Tree-walking Interpreterã€‚

**è®¾è®¡åŸåˆ™**:
1. **äºŒè¿›åˆ¶å­—èŠ‚ç **: å¯åºåˆ—åŒ–/ç¼“å­˜ï¼Œæ”¯æŒ AOT ç¼–è¯‘
2. **å±æ€§ç´¢å¼•è®¿é—®**: ç¼–è¯‘æœŸç¡®å®š field indexï¼Œè¿è¡Œæ—¶ O(1) åç§»è®¿é—®
3. **æ ˆå¸§è°ƒç”¨çº¦å®š**: åŸºäºæ ˆçš„å‚æ•°ä¼ é€’å’Œå±€éƒ¨å˜é‡ç®¡ç†
4. **åˆ†å±‚æ¶æ„**: å‰ç«¯ â†’ Bytecode â†’ VMï¼Œæ”¯æŒæœªæ¥ JIT/AOT æ‰©å±•

**æ ¸å¿ƒç»„ä»¶**:
```
src/
â””â”€â”€ runtime/
    â”œâ”€â”€ bytecode/
    â”‚   â”œâ”€â”€ mod.rs        # Opcode å®šä¹‰
    â”‚   â””â”€â”€ chunk.rs      # å­—èŠ‚ç å—
    â”œâ”€â”€ vm.rs             # è™šæ‹Ÿæœº (æ ˆ + æŒ‡ä»¤å¾ªç¯)
    â”œâ”€â”€ value.rs          # è¿è¡Œæ—¶å€¼è¡¨ç¤º (NaN Boxing)
    â””â”€â”€ compiler.rs       # AST â†’ Bytecode ç¼–è¯‘å™¨
```

**å…³é”®è®¾è®¡å†³ç­–** (å·²ç¡®å®š):

| å†³ç­–é¡¹ | æ–¹æ¡ˆ | çŠ¶æ€ |
|--------|------|------|
| **å€¼è¡¨ç¤º** | NaN Boxing + SMI ä¼˜åŒ– | âœ… å·²å®ç° |
| **æ•´æ•°ç±»å‹** | SMI (i30) + Float64 | âœ… å·²å®ç° |
| **æŒ‡ä»¤æ ¼å¼** | å®šé•¿æŒ‡ä»¤ (1-3 bytes) | âœ… å·²å®ç° |
| **å­—ç¬¦ä¸²** | UTF-8 | âœ… è®¾è®¡ç¡®å®š |

**è®¾è®¡æ–‡æ¡£**:
- [BYTECODE.md](BYTECODE.md) - å­—èŠ‚ç  VM è®¾è®¡
- [CLOSURE_COROUTINE_DESIGN.md](CLOSURE_COROUTINE_DESIGN.md) - é—­åŒ…ä¸åç¨‹æ–¹æ¡ˆé€‰å‹

**Phase 2 é‡Œç¨‹ç¢‘**:
- [x] å­—èŠ‚ç æ–¹æ¡ˆè®¾è®¡è¯„å®¡ âœ…
- [x] Opcode å®šä¹‰å®ç° âœ…
- [x] AST â†’ Bytecode ç¼–è¯‘å™¨ (åŸºç¡€è¡¨è¾¾å¼) âœ…
- [x] åŸºç¡€ VM æ‰§è¡Œå¼•æ“ âœ…
- [x] ç®€å•ç¨‹åºè·‘é€š (`return 1 + 2 * 3;`) âœ…
- [ ] å˜é‡æ”¯æŒ (å±€éƒ¨/å…¨å±€)
- [ ] æ§åˆ¶æµ (if/while/for)
- [ ] å‡½æ•°è°ƒç”¨
- [ ] åˆ—è¡¨å’Œå­—ç¬¦ä¸²

### Phase 3: åŠŸèƒ½è¿­ä»£

åœ¨é—­ç¯åŸºç¡€ä¸ŠæŒ‰éœ€æ·»åŠ åŠŸèƒ½ï¼š

| åŠŸèƒ½ | å·¥ä½œé‡ | ä¼˜å…ˆçº§ |
|------|--------|--------|
| å­—ç¬¦ä¸²è½¬ä¹‰ | 1 å¤© | é«˜ |
| æˆå‘˜/ç´¢å¼•èµ‹å€¼ | 2 å¤© | é«˜ |
| æµ®ç‚¹æ•° | 2 å¤© | ä¸­ |
| é—­åŒ… | 3 å¤© | ä¸­ |
| å¤åˆèµ‹å€¼ | 1 å¤© | ä½ |
| é”™è¯¯ä½ç½®æŠ¥å‘Š | 3 å¤© | ä¸­ |

---

## 5. å·²çŸ¥é—®é¢˜

> è¯¦ç»†é—®é¢˜åˆ—è¡¨è§ [ISSUES.md](ISSUES.md)

### 5.1 Phase 1 å·²ä¿®å¤

| é—®é¢˜ | ä½ç½® | çŠ¶æ€ |
|------|------|------|
| whitespace åŒ¹é…æ¢è¡Œ | `builder.rs` | âœ… å·²ä¿®å¤ |
| ç»“åˆæ€§ç¡¬ç¼–ç  | `utils.rs` | âœ… å·²ä¿®å¤ |
| æ— æ•ˆ check è°ƒç”¨ | `parser.rs` | âœ… ç»æŸ¥æ— æ­¤é—®é¢˜ |

### 5.2 å¾…ä¿®å¤ (åŠŸèƒ½ç¼ºå¤±)

| é—®é¢˜ | ä¼˜å…ˆçº§ | é¢„è®¡å·¥ä½œé‡ |
|------|--------|-----------|
| å­—ç¬¦ä¸²è½¬ä¹‰ | ğŸ”´ é«˜ | 1å¤© |
| æˆå‘˜/ç´¢å¼•èµ‹å€¼ | ğŸ”´ é«˜ | 2å¤© |
| ç´¢å¼•è®¿é—® | ğŸ”´ é«˜ | 1å¤© |
| æµ®ç‚¹æ•°æ”¯æŒ | ğŸŸ¡ ä¸­ | 2å¤© |
| é”™è¯¯ä½ç½®æŠ¥å‘Š | ğŸŸ¡ ä¸­ | 3å¤© |
| é—­åŒ…æ”¯æŒ | ğŸŸ¡ ä¸­ | 3å¤© |

### 5.3 æŠ€æœ¯å€ºåŠ¡

| é—®é¢˜ | è¯´æ˜ | ä¼˜åŒ–æ–¹æ¡ˆ |
|------|------|---------|
| åŠ¨æ€åˆ†å‘ | `Box<dyn Fn(char) -> bool>` | æ”¹ä¸ºå‡½æ•°æŒ‡é’ˆæˆ–æšä¸¾ |
| å­—ç¬¦ä¸²åˆ†é… | æ¯ä¸ª Token æ–°å»º String | è€ƒè™‘å­—ç¬¦ä¸² interning |
| AST å†…å­˜å¸ƒå±€ | `Box<ExprKind>` å°åˆ†é…å¤š | è€ƒè™‘ arena allocator |

---

## 6. ä½¿ç”¨æ–¹å¼

### 6.1 æ„å»º

```bash
cargo build --release
```

### 6.2 è¿è¡Œ

```bash
# è§£ææ–‡ä»¶
cargo run -- assets/a.txt

# è¿è¡Œæµ‹è¯•
cargo test
```

### 6.3 ç¤ºä¾‹ä»£ç 

```kaubo
// assets/a.txt
var a = 3;

var func = |x|{
    return x;
};

a = 5;
```

---

## 7. æœªæ¥æ¼”è¿›

```
Phase 1: æµ‹è¯•ä¸ä¿®å¤ï¼ˆå½“å‰ï¼‰
    â†“
Phase 2: å­—èŠ‚ç  VMï¼ˆè®¾è®¡ä¸­ï¼‰
    â†“
Phase 3: åŠŸèƒ½å®Œå–„ï¼ˆé—­åŒ…ã€æµ®ç‚¹ã€è½¬ä¹‰ã€GC ç­‰ï¼‰
    â†“
Phase 4: æ€§èƒ½ä¼˜åŒ–ï¼ˆJITã€å†…è”ç¼“å­˜ç­‰ï¼‰
    â†“
Phase 5: å¯é€‰ - WASM/LLVM åç«¯
```

**åç«¯æ–¹æ¡ˆæ¼”è¿›**:
- **Phase 2** ç›´æ¥é‡‡ç”¨å­—èŠ‚ç  VMï¼Œè·³è¿‡ Tree-walking é˜¶æ®µ
- å±æ€§è®¿é—®é‡‡ç”¨ç´¢å¼•åç§»ï¼Œä¸ºåç»­ä¼˜åŒ–æ‰“åŸºç¡€
- é¢„ç•™ JIT/AOT æ‰©å±•æ¥å£

---

## 8. å‚è€ƒèµ„æ–™

- [Pratt Parsing](https://matklad.github.io/2020/04/13/simple-but-powerful-pratt-parsing.html)
- [Crafting Interpreters](https://craftinginterpreters.com/)

---

*æ–‡æ¡£ç‰ˆæœ¬: 1.0*  
*æœ€åæ›´æ–°: 2026-02-08*
