# Kaubo 迭代路线图

> 项目分阶段推进，当前处于 **Phase 3**

---

## 概览

| 阶段 | 名称 | 状态 | 核心目标 |
|------|------|------|----------|
| Phase 1 | 基础设施 | ✅ 完成 | Lexer、Parser、基本VM |
| Phase 2 | 核心功能 | ✅ 完成 | 运算符重载、类型检查、标准库 |
| Phase 3 | 优化完善 | 🚧 进行中 | 内联缓存、测试覆盖、代码清理 |
| Phase 4 | JIT编译器 | 📋 规划中 | Cranelift集成、热点编译 |
| Phase 5 | 热重载 | 📋 规划中 | 状态保持、代码热更新 |

---

## Phase 1 - 基础设施（✅ 完成）

**时间**：2025-02 至 2025-Q2

### 已完成

- [x] 流式 Lexer（支持增量输入）
- [x] 递归下降 Parser
- [x] AST 定义
- [x] 字节码设计
- [x] 基本 VM（栈机实现）

### 关键决策

- 使用 NaN-boxing 的 Value 表示
- 栈与局部变量分离设计
- Upvalue 机制（类似 Lua）

---

## Phase 2 - 核心功能（✅ 完成）

**时间**：2025-Q2 至 2026-02

### 已完成

- [x] 类型检查器（基础）
- [x] 运算符重载（Level 3 元表查找）
- [x] Struct 和 Impl
- [x] 模块系统（import/from）
- [x] 协程（yield）
- [x] 标准库（math、file、list、string）
- [x] 日志系统（kaubo-log）

### 关键决策

- `operator add` 显式语法（非 `__add__`）
- Shape-based 对象系统
- 四级分发策略设计

---

## Phase 3 - 优化完善（🚧 进行中）

**时间**：2026-02 至今

### 已完成 ✅

- [x] Level 2 内联缓存集成完成
- [x] 提升测试覆盖率（核心模块 > 80%，kaubo-log > 96%）

### 进行中

- [ ] 清理技术债务（兼容方案标记）

### 待办

- [ ] 列表元素类型检查
- [ ] string→int/float 解析
- [ ] 增量解析（函数级）

### 进入 Phase 4 的条件

- [x] Level 2 内联缓存集成完成
- [x] 核心模块测试覆盖率 > 80%
- [ ] 性能基准测试建立

---

## Phase 4 - JIT编译器（📋 规划中）

**时间**：待定（预计 2026-Q2/Q3）

### 目标

实现基于 Cranelift 的 JIT 编译器，将热点函数编译为机器码。

### 关键任务

- [ ] Cranelift 依赖集成
- [ ] 热点检测机制
- [ ] AST → Cranelift IR 转换
- [ ] 解释器 ↔ JIT 切换
- [ ] 降级机制（JIT失败时回退到解释器）

### 性能目标

| 指标 | 目标值 |
|------|--------|
| JIT编译单函数 | < 100ms |
| JIT代码执行 | 比解释器快 5-10x |

### 依赖

- Phase 3 完成
- Cranelift 0.1xx+ 版本评估

---

## Phase 5 - 热重载（📋 规划中）

**时间**：待定（预计 Phase 4 完成后 2-3 个月）

### 目标

实现开发时的代码热更新，不丢失运行状态。

### 关键任务

- [ ] 状态序列化/反序列化
- [ ] 函数级代码替换
- [ ] `@hot` 注解设计与实现
- [ ] 安全点机制
- [ ] 版本检查与迁移

### 性能目标

| 指标 | 目标值 |
|------|--------|
| 热重载延迟 | < 1秒 |
| 状态恢复成功率 | > 99% |

### 依赖

- Phase 4 JIT 完成
- 确定性 Shape ID（已预留）
- 统一栈帧 ABI（已预留）

---

## 明确不做（复杂度预算外）

参见 [复杂度预算](../10-constraints/complexity-budget.md)

- 完整 GC（使用 Arena 足够）
- 多线程并行
- 跨平台支持（初期）
- 包管理器
- IDE/LSP 协议

---

## 决策记录

| 日期 | 决策 | 理由 |
|------|------|------|
| 2025-02 | 分 5 阶段推进 | 控制复杂度，逐步验证 |
| 2026-02 | 当前处于 Phase 3 | 核心功能完成，进入优化阶段 |
| 2026-02 | JIT推迟到Phase 4 | 优先保证解释器稳定，为JIT预留架构 |
| 2026-02 | 热重载推迟到Phase 5 | 依赖JIT，且需要更多架构预留 |

---

*最后更新：2026-02-16*
