# 已知问题记录

> 记录当前项目中存在的已知问题和技术债务，供后续迭代参考。

## Phase 2 状态

**Phase 2.1 (核心 Value + 算术)**: ✅ 已完成  
**Phase 2.2 (变量与控制流)**: 🚧 进行中

---

## Phase 2.2 待实现功能

### 高优先级

| 问题 | 影响 | 预计工作量 | 备注 |
|------|------|-----------|------|
| 局部变量支持 | 无法使用 `var x = 5;` | 2天 | 需要局部变量表和栈帧管理 |
| 变量引用编译 | 无法读取变量值 | 1天 | Compiler 需要支持 VarRef |
| 变量赋值编译 | 无法修改变量值 | 1天 | Compiler 需要支持 Assign |
| 控制流编译 | 无法执行 if/while/for | 2天 | 需要跳转指令的生成 |

### 中优先级

| 问题 | 影响 | 预计工作量 | 备注 |
|------|------|-----------|------|
| 全局变量 | 无法定义全局变量 | 1天 | HashMap 存储 |
| 逻辑运算短路 | `and`/`or` 不短路 | 1天 | 需要条件跳转 |
| 函数调用 | 无法调用函数 | 3天 | 需要栈帧和 Call 指令 |

---

## 前端功能缺失 (Phase 1 遗留)

### 高优先级

| 问题 | 影响 | 预计工作量 | 备注 |
|------|------|-----------|------|
| 字符串转义 | 无法使用 `"hello\n"` 这类带转义字符的字符串 | 1天 | 需要在 lexer 中处理转义序列 |
| 成员/索引赋值 | 不支持 `obj.x = 5` 或 `arr[0] = 1` | 2天 | 当前 parser 只支持简单变量赋值 |
| 索引访问 | 不支持 `arr[0]` 语法 | 1天 | 需要添加新的表达式类型 |

### 中优先级

| 问题 | 影响 | 预计工作量 | 备注 |
|------|------|-----------|------|
| 浮点数支持 | 只支持整数 | 2天 | 需要修改 lexer 和 value 表示 |
| 错误位置报告 | 错误信息不带行列号 | 3天 | ParserError 需要包含 Coordinate |
| 闭包支持 | Lambda 无法捕获外部变量 | 3天 | 需要环境/作用域设计 |

### 低优先级

| 问题 | 影响 | 预计工作量 | 备注 |
|------|------|-----------|------|
| 复合赋值 | 不支持 `+=`, `-=` 等 | 1天 | 语法糖和 AST 转换 |
| 多行字符串 | 不支持 `"""..."""` | 1天 | 语法扩展 |
| Unicode 标识符 | 标识符只能是 ASCII | 1天 | lexer 字符判断修改 |

---

## 技术债务

### 架构层面

| 问题 | 说明 | 风险 | 解决方案 |
|------|------|------|---------|
| 动态分发 | `Box<dyn Fn(char) -> bool>` 在 lexer 状态机中 | 运行时开销 | 改为函数指针或枚举 |
| 字符串分配 | 每个 Token 都新建 String | 内存开销大 | 考虑字符串 interning |
| AST 内存布局 | `Box<ExprKind>` 带来大量小分配 | 缓存不友好 | 考虑 arena allocator |
| VM 指针安全 | 使用裸指针 `*const u8` | 潜在的内存安全问题 | 考虑使用 safe 抽象 |

### 代码层面

| 文件 | 问题 | 严重程度 |
|------|------|---------|
| `main.rs` | 硬编码路径，无法测试 | 中 |
| `parser.rs` | 错误处理不够细化 | 低 |
| `token_kind.rs` | 大量未使用的 Token 类型 | 低 |
| `c_lexer.rs` | 包含大量调试 eprintln! | 低 |
| `vm.rs` | 部分指令未实现 (NotEqual/GreaterEqual/LessEqual/Not) | 中 |
| `compiler.rs` | 大量 AST 类型未编译 | 中 |

---

## 已修复问题

### Phase 1 修复记录

| 问题 | 位置 | 修复方案 | 状态 |
|------|------|---------|------|
| whitespace 匹配换行 | `builder.rs:125` | `c.is_whitespace()` → `c == ' '` | ✅ |
| 无效 check 调用 | `parser.rs:336` | 经查无此问题，行号已过时 | ✅ |
| 结合性硬编码 | `utils.rs:23` | 已实现正确的结合性判断 | ✅ |

### Phase 2.1 完成记录

| 任务 | 文件 | 状态 |
|------|------|------|
| NaN Boxing Value 实现 | `runtime/value.rs` | ✅ |
| OpCode 定义 | `runtime/bytecode/mod.rs` | ✅ |
| Chunk 字节码块 | `runtime/bytecode/chunk.rs` | ✅ |
| VM 执行引擎 | `runtime/vm.rs` | ✅ |
| AST → Bytecode 编译器 | `runtime/compiler.rs` | ✅ |
| End-to-End 测试 | `tests/` | ✅ |

---

## Phase 2.2 前置依赖

在继续实现变量和控制流之前，建议先解决：

1. **局部变量表设计** - 决定如何在栈帧中存储和访问局部变量
2. **变量作用域** - 决定作用域嵌套和变量查找规则
3. **栈帧布局** - 确定调用时的栈帧结构

---

*最后更新: 2026-02-08*
