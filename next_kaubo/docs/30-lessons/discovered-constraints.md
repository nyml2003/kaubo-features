# 发现的隐藏约束

不是预先设计，而是在探索中发现的硬性限制。

## 约束：热重载不能破坏正在执行的调用栈

- **发现时间**：2025-02-14（架构设计阶段）
- **适用阶段**：Phase 5（热重载实现阶段）
- **发现过程**：考虑热重载粒度时，意识到如果替换正在执行的函数，返回地址会失效
- **约束内容**：热重载只能替换**非活跃**的函数，或等待函数返回
- **影响**：需要设计"安全点"机制，或只允许在特定边界热重载
- **规划策略**：只在@hot函数边界检查版本，内部不热重载

## 约束：Shape ID必须在编译期稳定

- **发现时间**：2025-02-14（分析Kaubo现有代码）
- **发现过程**：现有Shape系统使用u16 ID，运行时依赖此ID做字段访问
- **约束内容**：热重载后，Shape ID不能改变，否则已序列化状态无法恢复
- **影响**：Shape ID生成必须是确定性的（基于struct名称和字段签名）
- **当前策略**：使用哈希生成ID，冲突时回退到顺序分配（记录冲突）
- **相关规划**：此约束为Phase 5热重载做架构预留，当前已按此实现

## 约束：JIT代码必须与解释器栈布局兼容

- **发现时间**：2025-02-14（架构设计阶段）
- **适用阶段**：Phase 4（JIT实现阶段）
- **发现过程**：考虑解释器→JIT切换时，需要共享局部变量
- **约束内容**：JIT生成的代码访问局部变量的方式，必须与解释器栈布局一致
- **影响**：需要定义统一的栈帧ABI
- **规划策略**：局部变量使用固定数组，JIT通过偏移访问
- **当前状态**：解释器已实现固定数组布局，为JIT预留兼容性

## 约束：文档命令示例必须使用PowerShell语法

- **发现时间**：2026-02-14（搭建文档结构时）
- **发现过程**：使用`mkdir -p docs/{a,b,c}`语法在PowerShell中失败
- **约束内容**：
  - 项目开发环境是Windows PowerShell
  - Unix shell语法（brace expansion、`||`操作符）不兼容
  - 文档中的命令示例必须用PowerShell语法
- **影响**：
  - 文档中的shell命令需测试PowerShell兼容性
  - AI生成命令时需明确指定PowerShell上下文
- **当前策略**：
  - 文档使用PowerShell语法
  - 或提供明确的跨平台说明

## 约束：日志系统需要零成本抽象（Release零开销）→ 【已推翻】

- **发现时间**：2026-02-14（项目维护中）
- **推翻时间**：2026-02-14（进一步讨论后）
- **推翻原因**：
  - 优先需要**结构化接口**，而非环境依赖（环境变量/CLI）
  - 需要CLI、嵌入、测试等不同环境下**一致的编程接口**
  - 性能可以妥协，接口兼容性不能妥协
- **新约束**：见 docs/00-principles/README.md 新增原则

## 约束：配置/日志必须提供结构化接口（环境无关）

- **发现时间**：2026-02-14（讨论CLI简化方案时）
- **发现过程**：
  - 提议用环境变量简化CLI参数，被否决
  - 需求：不同环境（CLI/嵌入/测试）使用**一致的结构化接口**
  - 不依赖控制台、环境变量等外部状态
- **约束内容**：
  - 配置必须通过代码级API传递，而非全局环境
  - CLI、嵌入、测试等不同入口使用同一套接口
  - 日志开启/关闭必须是可编程的，而非编译期开关
- **影响**：
  - 保持`RunConfig`等显式配置结构
  - 日志系统需要运行时过滤能力
  - 可以牺牲一点性能换取接口一致性
- **当前策略**：保留显式配置，优化其易用性，而非简化掉

## 约束：单元测试覆盖率不足是维护负担

- **发现时间**：2026-02-14（代码审查中）
- **发现过程**：修改代码时担心破坏现有功能，但测试不足以捕获回归
- **约束内容**：
  - 核心模块（lexer/parser/vm）需要更高覆盖率
  - 需要区分单元测试和集成测试
  - 测试需要快速运行（<5秒）以保证反馈循环
- **当前策略**：优先给核心数据结构和状态转换函数补测试

## 约束：代码中存在"兼容方案"（技术债务）

- **发现时间**：2026-02-14（代码审查中）
- **发现过程**：发现一些地方用了临时hack或过渡方案
- **约束内容**：
  - 兼容方案增加了理解成本
  - 需要标记并逐步清理
  - 新增代码不应再引入hack
- **当前策略**：标记所有兼容方案，制定清理计划

---

*发现新约束时，在此文件顶部追加*
