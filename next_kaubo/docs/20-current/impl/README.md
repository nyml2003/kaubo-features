# Kaubo 实现架构

> ⚠️ 此文件随时可能重写。这是当前实验状态，不是承诺。

---

## 当前架构（已实现）

```
源代码 (.kaubo)
      ↓
[流式Lexer] → Tokens
      ↓
[Parser] → AST
      ↓
[类型检查器] → Typed AST
      ↓
[字节码编译器] → Chunk
      ↓
[解释器/VM] → 执行结果
```

## 未来迭代计划（未实现）

```
[类型检查器] → Typed AST
      ↓
      ├─→ [解释器] → 立即执行（冷代码/调试）
      └─→ [JIT编译器] → 机器码 → 热点执行  ← Phase 4 计划
                    ↓
              [热重载层] ← 状态序列化/恢复  ← Phase 5 计划
```

---

## 组件边界

```
kaubo-core/
├── kit/lexer/      # 流式Lexer
├── compiler/
│   ├── parser/     # Parser
│   └── type_checker  # 类型检查器
└── runtime/
    ├── bytecode/   # 字节码定义
    ├── compiler.rs # AST → 字节码编译器
    ├── vm.rs       # 字节码解释器（VM）
    └── operators.rs # 运算符重载（Level 3，Level 2待集成）
```

## 未来组件（规划）

| 组件 | 阶段 | 状态 |
|------|------|------|
| jit/ | Phase 4 | 📋 规划中，依赖Cranelift |
| hotreload/ | Phase 5 | 📋 规划中，依赖JIT完成 |
| 增量Parser | Phase 3+ | 📋 规划中 |

---

## 关键设计决策（已实现）

### 1. 纯解释执行（当前）

当前仅实现字节码解释器，原因：
- 快速验证语言语义
- 为JIT提供正确的执行参考
- 复杂度预算内优先完成核心功能

### 2. 运算符重载：四级分发策略

已实现 Level 3（元表查找），Level 2（内联缓存）基础设施就绪待集成。

详见：[运算符重载文档](operators/README.md)

## 未来设计决策（规划中）

### JIT后端：Cranelift（Phase 4）

| 维度 | Cranelift | LLVM |
|------|-----------|------|
| 编译速度 | ✅ 快 | ❌ 慢 |
| 生成代码质量 | ⚠️ 一般 | ✅ 优秀 |
| 依赖复杂度 | ✅ 低 | ❌ 高 |

**计划**：Phase 4 引入 Cranelift，满足 <100ms 约束

### 热重载粒度：函数级（Phase 5）

- **选项A**：函数级（替换单个函数）← 当前倾向
- **选项B**：模块级（替换整个文件）

**挑战**：正在执行的函数如何安全替换？
**策略**：只在 @hot 函数边界检查版本，内部不热重载

---

## 技术风险与应对

### 当前风险

| 风险 | 影响 | 缓解方案 |
|------|------|---------|
| 纯解释器性能瓶颈 | 复杂脚本执行慢 | 先完成核心功能，再引入JIT |
| Level 2内联缓存未集成 | 运算符重载性能未达最优 | Phase 3 完成集成 |

### 未来风险（JIT/热重载阶段）

| 风险 | 影响 | 缓解方案 |
|------|------|---------|
| Cranelift编译时间>100ms | P0约束违反 | 降级到解释器+后台编译 |
| 热重载状态恢复失败 | 用户体验差 | 提供"冷启动"回退 |
| Shape系统与JIT冲突 | 架构重写 | 预留抽象层（已在Shape设计中预留）|

---

## 子系统文档

| 系统 | 文档 | 说明 |
|------|------|------|
| 运算符重载 | [operators/README.md](operators/README.md) | 四级分发策略 |
| 配置系统 | [config.md](config.md) | kaubo.json 格式 |

---

## 实验记录

- **2025-02-14**: 初始架构设计
- **2026-02-14**: [日志系统迁移](../../30-lessons/tracing-to-kaubo-log-migration.md) - 从 `tracing` 迁移到 `kaubo-log`

---

*此文件是工作区，不代表最终设计*
