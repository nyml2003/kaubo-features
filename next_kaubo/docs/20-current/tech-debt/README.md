# æŠ€æœ¯å€ºåŠ¡

> å·²çŸ¥æœªå®Œæˆçš„åŠŸèƒ½å’Œå¾…åŠäº‹é¡¹ã€‚æŒ‰ä¼˜å…ˆçº§å’Œç»„ä»¶ç»„ç»‡ã€‚

---

## ç±»å‹æ£€æŸ¥å™¨

### âœ… å·²å®Œæˆï¼ˆ2026-02-14ï¼‰

- if/while æ¡ä»¶ bool æ£€æŸ¥
- å‡½æ•°è°ƒç”¨å‚æ•°ç±»å‹æ£€æŸ¥ï¼ˆæ•°é‡ã€ç±»å‹ã€anyæ”¯æŒï¼‰
- Struct å­—æ®µç±»å‹æ£€æŸ¥
- æˆå‘˜è®¿é—®ç±»å‹æ¨å¯¼
- `as` ç±»å‹è½¬æ¢ï¼ˆintâ†”float, int/float/boolâ†’stringï¼‰
- `any` é¡¶å±‚ç±»å‹

### ğŸš§ æœªå®Œæˆ

| åŠŸèƒ½ | ç°çŠ¶ | ä¼˜å…ˆçº§ |
|------|------|--------|
| åˆ—è¡¨å…ƒç´ ç±»å‹æ£€æŸ¥ | æ¨å¯¼ä¸º `List<any>` è€ŒééªŒè¯ä¸€è‡´æ€§ | P2 |
| stringâ†’int/floatè§£æ | ä»…æ”¯æŒåŸºç¡€ç±»å‹è½¬æ¢ | P2 |
| ç±»å‹åˆ«å `type Point = ...` | æœªå®ç° | P3 |
| è”åˆç±»å‹ `int \| string` | æœªå®ç°ï¼Œéœ€å¤§é‡è®¾è®¡ | P3 |

---

## VM è™šæ‹Ÿæœº

### âœ… å·²å®Œæˆï¼ˆ2026-02-14ï¼‰

- å­—èŠ‚ç è§£é‡Šå™¨å®Œæ•´å®ç°
- ä¸€å…ƒè¿ç®—ç¬¦é‡è½½ï¼ˆnegï¼‰
- æ¯”è¾ƒè¿ç®—ç¬¦ï¼ˆlt/leï¼‰
- ç´¢å¼•è¿ç®—ç¬¦ï¼ˆget/setï¼‰
- åå‘è¿ç®—ç¬¦ï¼ˆradd/rmulï¼‰
- operator callï¼ˆå¯è°ƒç”¨å¯¹è±¡ï¼‰
- operator str/mod

### ğŸš§ æœªå®Œæˆï¼ˆå½“å‰é˜¶æ®µï¼‰

#### 1. Level 2 å†…è”ç¼“å­˜

**çŠ¶æ€**ï¼šåŸºç¡€è®¾æ–½å°±ç»ªï¼Œå¾…é›†æˆ

**ä»£ç ä½ç½®**ï¼š
- `kaubo-core/src/runtime/operators.rs` - `InlineCacheEntry`
- `kaubo-core/src/runtime/vm.rs` - `inline_caches`, `allocate_inline_cache`

**è®¾è®¡**ï¼š
```rust
pub struct InlineCacheEntry {
    pub left_shape: u16,
    pub right_shape: u16,
    pub closure: *mut ObjClosure,
    pub hit_count: u64,
    pub miss_count: u64,
}
```

**å¾…å®Œæˆ**ï¼š
- ä¿®æ”¹ Add/Sub/Mul/Div æŒ‡ä»¤ï¼Œæ·»åŠ ç¼“å­˜æ£€æŸ¥é€»è¾‘
- åœ¨ Chunk ä¸­åˆ†é…ç¼“å­˜æ§½ä½
- ç¼“å­˜é¢„çƒ­ç­–ç•¥

**é¢„æœŸæ€§èƒ½**ï¼šLevel 3 (~30-100ns) â†’ Level 2 (~15ns)ï¼Œæå‡ 2-6 å€

### ğŸ“‹ æœªæ¥é˜¶æ®µï¼ˆæœªå¼€å§‹ï¼‰

| åŠŸèƒ½ | é˜¶æ®µ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|------|
| JITç¼–è¯‘å™¨ | Phase 4 | ğŸ“‹ è§„åˆ’ä¸­ | åŸºäºCraneliftï¼Œè§£é‡Šå™¨å…œåº• |
| çƒ­é‡è½½ç³»ç»Ÿ | Phase 5 | ğŸ“‹ è§„åˆ’ä¸­ | ä¾èµ–JITå®Œæˆ |
| å¢é‡ç¼–è¯‘ | Phase 3+ | ğŸ“‹ è§„åˆ’ä¸­ | å‡½æ•°çº§å¢é‡è§£æ |

#### 2. Struct å­—ç¬¦ä¸²/æ•´æ•°é”®å­—æ®µè®¿é—®ï¼ˆå¾…ç§»é™¤ï¼‰

**çŠ¶æ€**ï¼šè¿‡æ¸¡é˜¶æ®µï¼Œå°†åœ¨ release ç‰ˆç§»é™¤

**èƒŒæ™¯**ï¼š
- å½“å‰ IndexGet æ”¯æŒ `struct["field"]` å’Œ `struct[0]` è®¿é—®å­—æ®µ
- ä½†è¿™ä¸ operator get è¯­ä¹‰å†²çªï¼Œä¸”æ€§èƒ½è¾ƒå·®

**è®¡åˆ’**ï¼š
1. å½“å‰ï¼šä¿ç•™å­—ç¬¦ä¸²/æ•´æ•°é”®å­—æ®µè®¿é—®ï¼ˆå…¼å®¹ï¼‰
2. è¿‡æ¸¡ï¼šæ·»åŠ ç¼–è¯‘å™¨è­¦å‘Šï¼Œå»ºè®®ä½¿ç”¨ `.field`
3. Releaseï¼šå®Œå…¨ç§»é™¤ï¼Œåªä¿ç•™ `.field` æ–¹å¼

---

## å®ç°è·¯çº¿å›¾

### Phase 3ï¼ˆå½“å‰ï¼‰- ä¼˜åŒ–ä¸å®Œå–„

| ç»„ä»¶ | åŠŸèƒ½ | ä¼˜å…ˆçº§ | çŠ¶æ€ |
|------|------|--------|------|
| VM | Level 2 å†…è”ç¼“å­˜ | P1 | ğŸš§ åŸºç¡€è®¾æ–½å°±ç»ª |
| VM | ç§»é™¤ struct å­—ç¬¦ä¸²é”®è®¿é—® | P2 | ğŸ“‹ è®¡åˆ’ä¸­ |
| Typer | åˆ—è¡¨å…ƒç´ ç±»å‹æ£€æŸ¥ | P2 | ğŸ“‹ å¾…åŠ |
| Typer | stringâ†’int/float è§£æ | P2 | ğŸ“‹ å¾…åŠ |
| Typer | ç±»å‹åˆ«å | P3 | ğŸ“‹ å¾…åŠ |
| Typer | è”åˆç±»å‹ | P3 | ğŸ“‹ å¾…åŠ |

### Phase 4ï¼ˆè§„åˆ’ï¼‰- JITç¼–è¯‘å™¨

| ç»„ä»¶ | åŠŸèƒ½ | ä¼˜å…ˆçº§ | çŠ¶æ€ |
|------|------|--------|------|
| JIT | Cranelifté›†æˆ | P0 | ğŸ“‹ è§„åˆ’ä¸­ |
| JIT | çƒ­ç‚¹æ£€æµ‹ | P1 | ğŸ“‹ è§„åˆ’ä¸­ |
| JIT | è§£é‡Šå™¨â†’JITåˆ‡æ¢ | P1 | ğŸ“‹ è§„åˆ’ä¸­ |

### Phase 5ï¼ˆè§„åˆ’ï¼‰- çƒ­é‡è½½

| ç»„ä»¶ | åŠŸèƒ½ | ä¼˜å…ˆçº§ | çŠ¶æ€ |
|------|------|--------|------|
| HotReload | çŠ¶æ€åºåˆ—åŒ– | P0 | ğŸ“‹ è§„åˆ’ä¸­ |
| HotReload | ä»£ç æ›¿æ¢ | P0 | ğŸ“‹ è§„åˆ’ä¸­ |
| HotReload | @hotæ³¨è§£ | P1 | ğŸ“‹ è§„åˆ’ä¸­ |

---

## å·²ä¿®å¤å€ºåŠ¡

### Shape ID å†²çªï¼ˆ2026-02-14ï¼‰

**é—®é¢˜**ï¼šåŸºç¡€ç±»å‹ shape_idï¼ˆ0-99ï¼‰ä¸è‡ªå®šä¹‰ struct shape_id å†²çª
- float = 1ï¼Œä½†ç¬¬ä¸€ä¸ª struct ä¹Ÿè¢«åˆ†é…äº† shape_id = 1
- å¯¼è‡´ `3.0 * v` æ—¶ï¼Œfloat æŸ¥æ‰¾åˆ°äº† Vector çš„ operator Mul

**ä¿®å¤**ï¼šstruct shape_id èµ·å§‹å€¼ä» 1 æ”¹ä¸º 100

```rust
// åŸºç¡€ç±»å‹ä½¿ç”¨ 0-99ï¼Œstruct ä» 100 å¼€å§‹é¿å…å†²çª
let mut next_shape_id: u16 = 100;
```

---

## ç›¸å…³æ–‡æ¡£

- [è¿ç®—ç¬¦é‡è½½](../impl/operators/README.md) - å››çº§åˆ†å‘ç­–ç•¥
- [æ¶æ„è®¾è®¡](../impl/README.md) - JIT ä¸ä¼˜åŒ–æ–¹å‘
