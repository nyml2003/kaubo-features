# 类型检查器技术债

> 当前类型检查器仅完成基础框架，以下功能待实现。
> 警告是有意的——它们标记未完成的功能点。

## 未完成的功能

### 1. if 语句条件类型检查

**位置**: `kaubo-core/src/compiler/parser/type_checker.rs:463`

```rust
// TODO: 检查条件类型是否为 bool
```

**现状**: 检查条件表达式但不验证类型
**影响**: 非 bool 条件（如 `if 1 + 2 {}`）不会报错
**优先级**: P1（基础类型安全）

---

### 2. 函数调用参数类型检查

**位置**: `kaubo-core/src/compiler/parser/type_checker.rs:720`

```rust
// TODO: 更详细的类型检查
```

**现状**: 检查参数表达式但不验证与形参类型匹配
**影响**: 参数类型不匹配不会报错（如 `func(123)` 传给 `string` 参数）
**优先级**: P0（核心类型安全）

---

### 3. Struct 字段类型检查

**位置**: `kaubo-core/src/compiler/parser/type_checker.rs:901`

```rust
// TODO: 检查字段名是否存在，类型是否匹配
```

**现状**: 
- 获取了 `field_defs` 但未使用
- 检查字段值表达式但不验证字段名存在性和类型匹配

**影响**: 
- 错误的字段名不会报错
- 字段类型不匹配不会报错

**优先级**: P1

---

### 4. 类型兼容性检查

**位置**: `kaubo-core/src/compiler/parser/type_checker.rs:922`

```rust
// TODO: 子类型检查、协变/逆变等
```

**现状**: `is_compatible` 仅检查完全相同类型，直接返回 `false`
**影响**: 
- 任何类型转换/兼容性检查都失败
- 影响赋值、传参、返回等场景

**优先级**: P0

---

## 废弃的设计

### SpanStack（kaubo-log）

**状态**: 已移除（2026-02-14）

**原因**: 
- `Logger` 直接使用 `Mutex<Vec<Span>>` 管理 span 栈
- `SpanStack` 是重复抽象，未被使用

**替代**: 使用 `Logger::enter_span()` 和 `SpanGuard` 模式

---

## 修复计划

| 优先级 | 任务 | 估算工作量 |
|--------|------|-----------|
| P0 | 实现 `is_compatible` 基础逻辑 | 2h |
| P0 | 函数调用参数类型检查 | 2h |
| P1 | if 条件 bool 检查 | 1h |
| P1 | struct 字段检查 | 3h |
| P2 | 子类型/协变逆变 | 8h+ |

---

## 设计决策记录

### 为什么不隐藏警告？

根据项目原则 #6（结构化接口优于环境依赖），未使用的变量表明：

1. **功能未完成**: 变量计算了值但没有后续使用（如 `cond_type` 没有验证）
2. **API 不匹配**: 获取了数据但没有使用（如 `field_defs`）

隐藏警告会掩盖这些技术债，而不是解决根本问题。
