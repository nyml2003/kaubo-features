# VM æŠ€æœ¯å€º

> æœ¬æ–‡æ¡£è®°å½•è™šæ‹Ÿæœºä¸­æ ‡è®°ä¸º `#[allow(dead_code)]` çš„æœªå®ŒæˆåŠŸèƒ½å’Œå¾…å®ç°ä¼˜åŒ–ã€‚

## æœªå®Œæˆçš„åŸºç¡€è®¾æ–½

### 1. å†…è”ç¼“å­˜ï¼ˆInline Cacheï¼‰

**çŠ¶æ€**: ğŸš§ é¢„ç•™æ¥å£ï¼ŒPhase 3 å®ç°

**ä»£ç ä½ç½®**: `kaubo-core/src/runtime/vm.rs`

```rust
#[allow(dead_code)]
inline_caches: Vec<InlineCacheEntry>,

#[allow(dead_code)]
fn allocate_inline_cache(&mut self) -> u8
```

**åŠŸèƒ½è¯´æ˜**:
- Level 2 ä¼˜åŒ–ï¼šç¼“å­˜ `(ShapeA, ShapeB) â†’ operator function` æ˜ å°„
- ç›®æ ‡å»¶è¿Ÿï¼šä» Level 3 çš„ 30-100ns ä¼˜åŒ–åˆ° ~15ns
- å®ç°æ—¶æœºï¼šè¿ç®—ç¬¦é‡è½½ Phase 3

**ç›¸å…³æ–‡æ¡£**: [è¿ç®—ç¬¦é‡è½½è®¾è®¡](operator-overloading.md)

---

### 2. ä¸€å…ƒè¿ç®—ç¬¦é‡è½½

**çŠ¶æ€**: âœ… å·²å®ç°ï¼ˆ2026-02-14ï¼‰

**ä»£ç ä½ç½®**: `kaubo-core/src/runtime/vm.rs`

å·²æ”¯æŒçš„è¿ç®—ç¬¦ï¼š
- `operator neg`ï¼ˆä¸€å…ƒè´Ÿå·ï¼‰âœ…
- `operator lt/le`ï¼ˆæ¯”è¾ƒï¼‰âœ…
- `operator get/set`ï¼ˆç´¢å¼•ï¼‰âœ…

**æ³¨æ„**: `call_unary_operator` ä»æ ‡è®° `#[allow(dead_code)]` ä»¥é¿å…è­¦å‘Šï¼Œä½† Neg æŒ‡ä»¤å·²è°ƒç”¨å®ƒã€‚

---

### 3. Struct å­—ç¬¦ä¸²/æ•´æ•°é”®å­—æ®µè®¿é—®ï¼ˆå¾…ç§»é™¤ï¼‰

**çŠ¶æ€**: âš ï¸ è¿‡æ¸¡é˜¶æ®µï¼Œå°†åœ¨ release ç‰ˆç§»é™¤

**ä»£ç ä½ç½®**: 
- `kaubo-core/src/runtime/vm.rs` - `index_get_base`
- `kaubo-core/src/runtime/vm.rs` - `call_operator_closure` - IndexGet

**èƒŒæ™¯**: 
- å½“å‰ IndexGet æ”¯æŒ `struct["field"]` å’Œ `struct[0]` è®¿é—®å­—æ®µ
- ä½†è¿™ä¸ operator get è¯­ä¹‰å†²çªï¼Œä¸”æ€§èƒ½è¾ƒå·®

**è®¡åˆ’**:
1. **å½“å‰**: ä¿ç•™å­—ç¬¦ä¸²/æ•´æ•°é”®å­—æ®µè®¿é—®ï¼ˆå…¼å®¹ç°æœ‰ä»£ç ï¼‰
2. **è¿‡æ¸¡**: æ·»åŠ ç¼–è¯‘å™¨è­¦å‘Šï¼Œå»ºè®®ä½¿ç”¨ `.field`
3. **Release**: å®Œå…¨ç§»é™¤ï¼Œåªä¿ç•™ `.field` æ–¹å¼

**å½±å“**: 
- éœ€è¦æ”¹è¿›ç±»å‹æ¨æ–­ï¼Œè®©ç¼–è¯‘å™¨èƒ½æ¨æ–­æ›´å¤šè¡¨è¾¾å¼çš„ç±»å‹
- æˆ–ä½¿ç”¨æ˜¾å¼ç±»å‹æ ‡æ³¨

**ç›¸å…³åŸåˆ™**: [æ˜¾å¼å‘½åä¼˜äºéšå¼çº¦å®š](../../00-principles/README.md#8-æ˜¾å¼å‘½åä¼˜äºéšå¼çº¦å®š)

---

## å®ç°è·¯çº¿å›¾

| é˜¶æ®µ | åŠŸèƒ½ | ä¼˜å…ˆçº§ | é¢„è®¡å·¥ä½œé‡ | çŠ¶æ€ |
|------|------|--------|-----------|------|
| Phase 2 | ä¸€å…ƒè¿ç®—ç¬¦é‡è½½ | P1 | 2 å¤© | âœ… å®Œæˆ |
| Phase 2 | æ¯”è¾ƒè¿ç®—ç¬¦ (lt/le) | P1 | 1 å¤© | âœ… å®Œæˆ |
| Phase 2 | ç´¢å¼•è¿ç®—ç¬¦ (get/set) | P1 | 1 å¤© | âœ… å®Œæˆ |
| Phase 3 | åå‘è¿ç®—ç¬¦ (radd/rmul) | P2 | 1 å¤© | âœ… å®Œæˆ |
| Phase 3 | operator call | P2 | 1 å¤© | âœ… å®Œæˆ |
| Phase 3 | operator str/mod | P2 | 1 å¤© | âœ… å®Œæˆ |
| Phase 3 | å†…è”ç¼“å­˜ Level 2 | P1 | 3 å¤© | ğŸš§ åŸºç¡€è®¾æ–½å°±ç»ªï¼Œå¾…é›†æˆ |
| Release | ç§»é™¤ struct å­—ç¬¦ä¸²é”®è®¿é—® | P2 | 1 å¤© | ğŸ“‹ è®¡åˆ’ä¸­ |

---

---

### 4. Level 2 å†…è”ç¼“å­˜ï¼ˆåŸºç¡€è®¾æ–½å°±ç»ªï¼‰

**çŠ¶æ€**: ğŸš§ åŸºç¡€è®¾æ–½å°±ç»ªï¼Œå¾…é›†æˆåˆ°æŒ‡ä»¤

**ä»£ç ä½ç½®**: 
- `kaubo-core/src/runtime/operators.rs` - `InlineCacheEntry`
- `kaubo-core/src/runtime/vm.rs` - `inline_caches`, `allocate_inline_cache`

**è®¾è®¡**:
```rust
pub struct InlineCacheEntry {
    pub left_shape: u16,      // å·¦æ“ä½œæ•° Shape ID
    pub right_shape: u16,     // å³æ“ä½œæ•° Shape ID
    pub closure: *mut ObjClosure, // ç¼“å­˜çš„è¿ç®—ç¬¦é—­åŒ…
    pub hit_count: u64,       // å‘½ä¸­ç»Ÿè®¡
    pub miss_count: u64,      // æœªå‘½ä¸­ç»Ÿè®¡
}
```

**å·¥ä½œåŸç†**:
1. é¦–æ¬¡æ‰§è¡Œ Add/Sub/Mul/Div ç­‰æŒ‡ä»¤æ—¶ï¼ŒæŸ¥æ‰¾ operator å¹¶å¡«å…¥ç¼“å­˜
2. åç»­æ‰§è¡Œæ—¶ï¼Œæ£€æŸ¥ (left_shape, right_shape) æ˜¯å¦åŒ¹é…ç¼“å­˜
3. å‘½ä¸­åˆ™ç›´æ¥è°ƒç”¨ç¼“å­˜çš„ closureï¼Œè·³è¿‡ Shape æŸ¥æ‰¾ï¼ˆ~15nsï¼‰
4. æœªå‘½ä¸­åˆ™é‡æ–°æŸ¥æ‰¾å¹¶æ›´æ–°ç¼“å­˜

**å¾…å®Œæˆ**:
- ä¿®æ”¹ Add/Sub/Mul/Div ç­‰æŒ‡ä»¤ï¼Œæ·»åŠ ç¼“å­˜æ£€æŸ¥é€»è¾‘
- åœ¨ Chunk ä¸­åˆ†é…ç¼“å­˜æ§½ä½
- ç¼“å­˜é¢„çƒ­ç­–ç•¥ï¼ˆé¿å…å†·å¯åŠ¨æƒ©ç½šï¼‰

**é¢„æœŸæ€§èƒ½æå‡**:
- Level 3 (Shape æŸ¥æ‰¾): ~30-100ns
- Level 2 (ç¼“å­˜å‘½ä¸­): ~15ns
- æå‡: 2-6 å€

---

## å·²ä¿®å¤çš„æŠ€æœ¯å€ºåŠ¡

### Shape ID å†²çªï¼ˆ2026-02-14ï¼‰

**é—®é¢˜**: åŸºç¡€ç±»å‹ shape_idï¼ˆ0-99ï¼‰ä¸è‡ªå®šä¹‰ struct shape_id å†²çª
- float = 1ï¼Œä½†ç¬¬ä¸€ä¸ª structï¼ˆVectorï¼‰ä¹Ÿè¢«åˆ†é…äº† shape_id = 1
- å¯¼è‡´ `3.0 * v` æ—¶ï¼Œfloat æŸ¥æ‰¾åˆ°äº† Vector çš„ operator Mul

**ä¿®å¤**: 
- å°† struct shape_id èµ·å§‹å€¼ä» 1 æ”¹ä¸º 100
- åŸºç¡€ç±»å‹ä¿ç•™ 0-99

**ä»£ç ä½ç½®**: `kaubo-core/src/runtime/compiler.rs`

```rust
// åŸºç¡€ç±»å‹ä½¿ç”¨ 0-99ï¼Œstruct ä» 100 å¼€å§‹é¿å…å†²çª
let mut next_shape_id: u16 = 100;
```

**ç›¸å…³æäº¤**: ä¿®å¤åå‘è¿ç®—ç¬¦æ—¶ä¸€èµ·ä¿®å¤

---

## ç›¸å…³æ–‡æ¡£

- [è¿ç®—ç¬¦é‡è½½è®¾è®¡](operator-overloading.md) - å››çº§åˆ†å‘ç­–ç•¥
- [æ¶æ„è®¾è®¡](architecture.md) - JIT ä¸ä¼˜åŒ–æ–¹å‘
