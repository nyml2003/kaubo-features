# 测试与覆盖率计划

> 测试覆盖率提升计划和已知限制跟踪

## 当前状态 (2026-02-12)

```
测试状态: 383 passed, 0 failed
Phase 1: ✅ 已完成 (浮点数字面量、短路求值、字符串转义)
Phase 2: 🚧 进行中 (垃圾回收、执行限制、标准库完善)
总分支覆盖率: ~65%
目标: 90%
```

### 各模块分支覆盖率

| 模块 | 当前 | 目标 | 优先级 | 状态 |
|------|------|------|--------|------|
| vm.rs | ~55% | 90% | P0 (核心执行) | 🚧 |
| compiler.rs | ~60% | 90% | P0 (核心编译) | 🚧 |
| stdlib/mod.rs | ~65% | 90% | P1 (标准库) | 🚧 |
| object.rs | ~15% | 80% | P1 (对象操作) | ⏳ |
| parser/*.rs | ~75% | 85% | P2 (语法分析) | ✅ |
| lexer/*.rs | ~85% | 85% | P2 (词法分析) | ✅ |

## ✅ Phase 1: 核心功能完善 (已完成)

### 1.1 浮点数字面量支持
- [x] Lexer: `scan_number()` 识别小数点和科学计数法
- [x] Parser: `parse_float()` 解析浮点 AST 节点
- [x] Compiler: `LiteralFloat` 编译为 `Value::float()`
- [x] Tests: 4个浮点测试全部通过

### 1.2 逻辑运算符短路求值
- [x] Compiler: `compile_and()` / `compile_or()` 生成跳转指令
- [x] VM: `JumpIfFalse` 配合栈管理实现短路
- [x] Tests: 10个短路测试全部通过

### 1.3 字符串转义序列
- [x] Lexer: `parse_escape()` 支持 `\n`, `\t`, `\\`, `\"`, `\r`, `\'`
- [x] Tests: 7个转义测试全部通过

**新增测试: 21个 | 总测试: 383个**

## 🚧 Phase 2: 核心功能补全 (进行中)

### 2.1 执行限制生效 (高优先级)
- [ ] VM 检查 `max_stack_size` 栈溢出保护
- [ ] VM 检查 `max_recursion_depth` 递归深度限制
- [ ] 配置传递: `LimitConfig` → VM 执行

### 2.2 标准库完善 (高优先级)
- [ ] `std.len(x)` - 字符串/列表长度
- [ ] `std.push(list, x)` - 列表追加元素
- [ ] `std.pop(list)` - 列表弹出元素
- [ ] 导出函数注册到标准库模块

### 2.3 垃圾回收 (中优先级)
- [ ] 标记-清除 GC 实现
- [ ] 对象头添加标记位
- [ ] GC 触发策略（分配阈值）

## Phase 3: 覆盖率提升到 90%

### 3.1 编译器分支覆盖
- [ ] 所有表达式类型的编译路径
- [ ] 所有语句类型的编译路径
- [ ] 错误恢复路径

### 3.2 标准库分支覆盖
- [ ] 所有 std 函数的参数校验分支
- [ ] 错误返回分支
- [ ] 边界条件分支

### 3.3 对象操作覆盖
- [ ] 所有 Value 类型的创建和访问
- [ ] 内存分配失败路径
- [ ] GC 相关路径

## 高优先级开发任务

来自 TODO 的高优先级任务：

### 错误处理完善 ⭐⭐⭐

- [ ] 添加调用堆栈追踪
- [ ] 保留源码位置信息在字节码中
- [ ] 常见错误提示（如未导入的模块）

### 字节码版本号 ⭐⭐⭐

- [ ] 魔数 "KAUB" 头
- [ ] 主/次版本号 (u16)
- [ ] 版本兼容性检查

## 中优先级功能

### 1. @ProgramStart 装饰器 (语法已实现，运行时未实现)

- [x] Parser 支持装饰器语法
- [ ] Compiler 生成入口点检查
- [ ] 运行时自动调用 `run` 函数

### 2. 字节码版本号

- [ ] 魔数 "KAUB" 头
- [ ] 主/次版本号 (u16)
- [ ] 版本兼容性检查

### 3. 错误处理完善

- [ ] 添加调用堆栈追踪
- [ ] 保留源码位置信息在字节码中
- [ ] 常见错误提示优化

## 覆盖率提升策略

1. **从高频路径开始** - 先覆盖最常用的指令和代码路径
2. **边界条件优先** - 0、1、最大值、空值等边界
3. **错误路径补充** - runtime error 的分支
4. **避免过度测试** - 相似路径合并，不追求 100%

## 测试文件结构

```
kaubo-core/tests/
├── vm_tests.rs           # 现有 VM 测试
├── compiler_tests.rs     # 编译器测试（新建）
├── stdlib_tests.rs       # 现有标准库测试
├── value_tests.rs        # Value 类型测试（新建）
├── integration_tests.rs  # 现有集成测试
└── coverage/             # 覆盖率专用测试
    ├── vm_coverage.rs    # VM 指令覆盖
    ├── compiler_coverage.rs
    └── edge_cases.rs     # 边界条件
```
